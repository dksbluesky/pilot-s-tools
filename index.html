<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor Edition V2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-color: #1a1c23; --card-bg: #242731; --accent-blue: #4dabf7;
            --text-main: #e0e0e0; --text-dim: #a0a0a0; --highlight: #51cf66; --orange: #e67e22;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: #333; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; }
        .tab-btn.active { background: var(--accent-blue); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .raw-data { font-family: 'Courier New', monospace; color: var(--highlight); font-weight: bold; font-size: 1.1em; border-left: 4px solid var(--highlight); padding-left: 10px; margin: 10px 0; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { background: #2d303a; padding: 10px; border-radius: 6px; }
        .label { font-size: 0.75em; color: var(--text-dim); display: block; }
        .value { font-size: 1.1em; font-weight: bold; }
        .pattern-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pattern-table th { font-size: 0.7em; color: var(--text-dim); text-align: left; padding: 4px; }
        .pattern-table td { padding: 8px 4px; border-bottom: 1px solid #444; font-weight: bold; }
        .wca-tag { color: #ff4757; font-size: 0.8em; margin-left: 5px; }
        #map { height: 250px; border-radius: 8px; margin-top: 10px; border: 1px solid #444; }
        select, .toggle-container { width: 100%; padding: 12px; background: #2d303a; color: white; border: 1px solid #444; border-radius: 6px; margin-top: 5px; box-sizing: border-box; }
        .traffic-toggle { display: flex; gap: 10px; margin-top: 10px; }
        .traffic-toggle button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background: #444; color: white; }
        .traffic-toggle button.active { background: var(--orange); }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">Tab 1: Ê∞£Ë±°Ëß£Á¢º</button>
        <button class="tab-btn" onclick="switchTab(2)">Tab 2: ‰∫îÈÇäË®àÁÆó</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card">
            <span class="label">AIRPORT SELECT</span>
            <select id="airportSelect" onchange="fetchMetar()">
                <optgroup label="üáπüáº Âè∞ÁÅ£">
                    <option value="RCSS" selected>RCSS - ÊùæÂ±±</option>
                    <option value="RCTP">RCTP - Ê°ÉÂúí</option>
                    <option value="RCKH">RCKH - È´òÈõÑ</option>
                    <option value="RCNN">RCNN - Âè∞Âçó</option>
                </optgroup>
                <optgroup label="üåè ÂúãÈöõ">
                    <option value="VHHH">VHHH - È¶ôÊ∏Ø</option>
                    <option value="RJTT">RJTT - ÁæΩÁî∞</option>
                </optgroup>
            </select>
        </div>

        <div class="card">
            <span class="label">RAW DATA (FIRST)</span>
            <div id="rawMetar" class="raw-data">Fetching...</div>
        </div>

        <div class="card">
            <span class="label">EST. RUNWAY & MAP</span>
            <div class="info-grid">
                <div class="info-item"><span class="label">Âª∫Ë≠∞Ë∑ëÈÅì</span><div id="estRunway" class="value" style="color:var(--accent-blue)">--</div></div>
                <div class="info-item"><span class="label">È¢®ÂäõÂàÜÈáè</span><div id="windComp" class="value">--</div></div>
            </div>
            <div id="map"></div>
        </div>

        <div class="card">
            <span class="label">DECODER</span>
            <div class="info-grid">
                <div class="info-item"><span class="label">VIS</span><div id="vis" class="value">--</div></div>
                <div class="info-item"><span class="label">QNH</span><div id="qnh" class="value">--</div></div>
                <div class="info-item" style="grid-column: span 2;"><span class="label">CLOUDS</span><div id="clouds" class="value">--</div></div>
                <div class="info-item" style="grid-column: span 2;"><span class="label">NOSIG/RMK</span><div id="remarks" class="value" style="font-size:0.9em">--</div></div>
            </div>
        </div>
        <button onclick="transferToTab2()" style="width:100%; padding:15px; background:var(--orange); color:white; border:none; border-radius:8px; font-weight:bold;">ÂÇ≥ÈÄÅËá≥‰∫îÈÇäË®àÁÆó ‚ûî</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <span class="label">RUNWAY & TRAFFIC SIDE</span>
            <select id="tab2Runway" onchange="updateTab2()"></select>
            <div class="traffic-toggle">
                <button id="leftTraffic" class="active" onclick="setTraffic('L')">LEFT Traffic</button>
                <button id="rightTraffic" onclick="setTraffic('R')">RIGHT Traffic</button>
            </div>
        </div>

        <div class="card">
            <span class="label">‰∫îÈÇäÊï∏Êìö (TAS: 90kt)</span>
            <table class="pattern-table">
                <thead><tr><th>Ëà™ÊÆµ Leg</th><th>Track</th><th>WCA</th><th>Heading (Fly)</th></tr></thead>
                <tbody id="patternBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const airportDB = {
    "RCSS": { coords: [25.0697, 121.5525], rwys: { "10": 100, "28": 280 } },
    "RCTP": { coords: [25.0797, 121.2342], rwys: { "05L": 52, "05R": 52, "23L": 232, "23R": 232 } },
    "RCKH": { coords: [22.5771, 120.3500], rwys: { "09": 90, "27": 270 } },
    "RCNN": { coords: [22.9507, 120.2058], rwys: { "18R": 180, "36L": 360 } }
};

let map, marker, patternRect, currentData = null, trafficSide = 'L';

function initMap() {
    map = L.map('map').setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=6170aad10236423390a448361754469c').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternRect = L.polyline([], {color: '#4dabf7', weight: 3, dashArray: '5, 10'}).addTo(map);
}

function switchTab(n) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab' + n).classList.add('active');
    document.querySelectorAll('.tab-btn')[n-1].classList.add('active');
    if(n === 1) setTimeout(() => map.invalidateSize(), 200);
}

async function fetchMetar() {
    const icao = document.getElementById('airportSelect').value;
    const mock = `${icao} 010500Z 05012KT 9999 FEW015 SCT080 20/14 Q1015 NOSIG RMK (TRAINING)`;
    document.getElementById('rawMetar').innerText = mock;
    decode(mock, icao);
}

function decode(raw, icao) {
    const wind = raw.match(/(\d{3})(\d{2,3})KT/);
    const dir = wind ? parseInt(wind[1]) : 0;
    const spd = wind ? parseInt(wind[2]) : 0;
    const ap = airportDB[icao];
    let best = "--", minD = 180;
    for(let r in ap.rwys) {
        let d = Math.abs(dir - ap.rwys[r]); if(d>180) d=360-d;
        if(d < minD) { minD = d; best = r; }
    }
    const rad = (minD * Math.PI) / 180;
    currentData = { icao, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };
    document.getElementById('estRunway').innerText = best;
    document.getElementById('windComp').innerText = `H: ${currentData.hw} / C: ${currentData.cw}`;
    document.getElementById('vis').innerText = "10km+";
    document.getElementById('qnh').innerText = "1015 hPa";
    document.getElementById('clouds').innerText = "FEW 1500ft, SCT 8000ft";
    document.getElementById('remarks').innerText = "NOSIG - No significant change expected.";
    map.setView(ap.coords, 14);
    marker.setLatLng(ap.coords);
    drawPattern(icao, best);
}

function drawPattern(icao, rwy) {
    const ap = airportDB[icao];
    const hdg = ap.rwys[rwy];
    const lat = ap.coords[0], lon = ap.coords[1];
    const dist = 0.015; // ÊØî‰æãÂ∏∏Êï∏
    const side = trafficSide === 'L' ? -1 : 1;
    
    // Ë®àÁÆóÂõõÂÄãËßí (Á∞°ÂñÆ‰∏âËßíÂáΩÊï∏‰º∞ÁÆóÈï∑ÊñπÂΩ¢)
    const angle = (hdg - 90) * Math.PI / 180;
    const p1 = [lat + Math.cos(angle)*dist*2, lon + Math.sin(angle)*dist*2]; // Final
    const p2 = [lat - Math.cos(angle)*dist*2, lon - Math.sin(angle)*dist*2]; // Upwind
    const p3 = [p2[0] + Math.cos(angle + Math.PI/2*side)*dist, p2[1] + Math.sin(angle + Math.PI/2*side)*dist]; // Crosswind
    const p4 = [p1[0] + Math.cos(angle + Math.PI/2*side)*dist, p1[1] + Math.sin(angle + Math.PI/2*side)*dist]; // Downwind
    
    patternRect.setLatLngs([p1, p2, p3, p4, p1]);
}

function setTraffic(s) {
    trafficSide = s;
    document.getElementById('leftTraffic').classList.toggle('active', s==='L');
    document.getElementById('rightTraffic').classList.toggle('active', s==='R');
    updateTab2();
}

function transferToTab2() {
    const sel = document.getElementById('tab2Runway');
    sel.innerHTML = "";
    for(let r in airportDB[currentData.icao].rwys) {
        let opt = new Option("RWY " + r, r);
        if(r === currentData.best) opt.selected = true;
        sel.add(opt);
    }
    updateTab2();
    switchTab(2);
}

function calculateWCA(track, windDir, windSpd, tas = 90) {
    const angle = (windDir - track) * Math.PI / 180;
    const wcaRad = Math.asin((windSpd * Math.sin(angle)) / tas);
    const wcaDeg = Math.round(wcaRad * 180 / Math.PI);
    return isNaN(wcaDeg) ? 0 : wcaDeg;
}

function updateTab2() {
    const rwy = document.getElementById('tab2Runway').value;
    const hdg = airportDB[currentData.icao].rwys[rwy];
    const side = trafficSide === 'L' ? -1 : 1;
    const tas = 90;
    
    const legs = [
        { name: "Upwind", track: hdg },
        { name: "Crosswind", track: (hdg + 270 * side + 360) % 360 },
        { name: "Downwind", track: (hdg + 180) % 360 },
        { name: "Base", track: (hdg + 90 * side + 360) % 360 },
        { name: "Final", track: hdg }
    ];

    let html = "";
    legs.forEach(l => {
        const wca = calculateWCA(l.track, currentData.dir, currentData.spd, tas);
        const flyHdg = (l.track + wca + 360) % 360;
        html += `<tr><td>${l.name}</td><td>${l.track.toString().padStart(3,'0')}¬∞</td>
                 <td class="wca-tag">${wca > 0 ? '+' : ''}${wca}¬∞</td>
                 <td>${flyHdg.toString().padStart(3,'0')}¬∞</td></tr>`;
    });
    document.getElementById('patternBody').innerHTML = html;
    drawPattern(currentData.icao, rwy);
}

window.onload = () => { initMap(); fetchMetar(); };
</script>
</body>
</html>
