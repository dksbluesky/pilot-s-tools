<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor Edition V3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-dark: #12141a; --card-bg: #1c1e26; --accent-blue: #4dabf7;
            --text-main: #ffffff; --text-dim: #94a3b8; --highlight: #51cf66;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; }
        
        /* Tab Navigation */
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 12px; background: #2d3139; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; }
        .tab-btn.active { background: #252a33; border-bottom: 3px solid var(--accent-blue); opacity: 1; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .label-sm { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Pocket METAR UI Clone */
        .est-runway-container { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .rwy-big { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .v-divider { width: 1px; height: 50px; background: #444; }
        .wind-details { font-size: 1rem; color: #fff; }
        .wind-details .val { color: var(--highlight); font-weight: bold; }

        /* Raw & Decoder */
        .raw-box { font-family: "SF Mono", "Roboto Mono", monospace; color: var(--highlight); line-height: 1.4; font-size: 0.95rem; margin-top: 8px; }
        .decoder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .decoder-item { background: #252a33; padding: 10px; border-radius: 8px; }

        /* Compass */
        .compass-box { position: relative; width: 180px; height: 180px; margin: 15px auto; border: 2px solid #333; border-radius: 50%; background: #16191f; }
        .compass-needle { position: absolute; top: 50%; left: 50%; width: 4px; height: 70px; background: #ff4757; transform-origin: bottom center; transition: 0.5s; z-index: 5; }
        .rwy-strip { position: absolute; top: 50%; left: 50%; width: 10px; height: 120px; background: #ffffff33; transform-origin: center; z-index: 1; }

        #map { height: 220px; border-radius: 12px; margin-top: 10px; background: #000; }
        select, .btn-action { width: 100%; padding: 14px; background: #2d3139; color: white; border: 1px solid #444; border-radius: 8px; font-size: 1rem; }
        .toggle-traffic { display: flex; gap: 8px; margin-top: 10px; }
        .toggle-traffic button { flex: 1; padding: 10px; border: none; border-radius: 6px; background: #333; color: white; cursor: pointer; }
        .toggle-traffic button.active { background: #e67e22; font-weight: bold; }
        
        .wca-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .wca-table th { text-align: left; color: var(--text-dim); padding: 5px; }
        .wca-table td { padding: 8px 5px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">機場氣象</button>
        <button class="tab-btn" onclick="switchTab(2)">起降計算</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card">
            <span class="label-sm">ICAO 機場選擇</span>
            <select id="airportSelect" onchange="fetchMetar()"></select>
        </div>

        <div class="card">
            <span class="label-sm">原始電碼 RAW DATA</span>
            <div id="rawMetar" class="raw-box">正在取得...</div>
        </div>

        <div class="card">
            <span class="label-sm">預估使用跑道 EST. RUNWAY</span>
            <div class="est-runway-container">
                <div id="estRunway" class="rwy-big">--</div>
                <div class="v-divider"></div>
                <div class="wind-details">
                    <div>頂風 Head: <span id="valHead" class="val">0</span> KT</div>
                    <div>側風 Cross: <span id="valCross" class="val">0</span> KT</div>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">機場位置與五邊航線</span>
            <div id="map"></div>
        </div>

        <div class="card">
            <span class="label-sm">電碼解譯 DECODER</span>
            <div class="decoder-grid">
                <div class="decoder-item"><span class="label-sm">能見度</span><div id="vis" style="font-weight:bold">--</div></div>
                <div class="decoder-item"><span class="label-sm">氣壓 QNH</span><div id="qnh" style="font-weight:bold">--</div></div>
                <div class="decoder-item" style="grid-column: span 2;"><span class="label-sm">雲層 CLOUDS</span><div id="clouds" style="font-weight:bold">--</div></div>
                <div class="decoder-item" style="grid-column: span 2;"><span class="label-sm">備註 RMK/NOSIG</span><div id="rmk" style="font-size:0.85rem">--</div></div>
            </div>
        </div>
        <button class="btn-action" style="background:#e67e22; border:none; margin-top:10px" onclick="transferToTab2()">傳送至計算頁面 ➔</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <span class="label-sm">選擇跑道與航線邊</span>
            <select id="tab2Runway" onchange="updateTab2()"></select>
            <div class="toggle-traffic">
                <button id="btnL" class="active" onclick="setTraffic('L')">LEFT Traffic</button>
                <button id="btnR" onclick="setTraffic('R')">RIGHT Traffic</button>
            </div>
        </div>

        <div class="card" style="text-align:center">
            <span class="label-sm">羅盤方位指示 (Heading/Wind)</span>
            <div class="compass-box">
                <div id="rwyStrip" class="rwy-strip"></div>
                <div id="windArrow" class="compass-needle"></div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">五邊修正數據 (WCA Calculation @ 90kt)</span>
            <table class="wca-table">
                <thead><tr><th>航段</th><th>Track</th><th>WCA</th><th>Heading</th></tr></thead>
                <tbody id="wcaBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const airportDB = {
    "RCSS": { name: "松山", coords: [25.0697, 121.5525], rwys: { "10": 100, "28": 280 } },
    "RCTP": { name: "桃園", coords: [25.0797, 121.2342], rwys: { "05L": 52, "05R": 52, "23L": 232, "23R": 232 } },
    "RCKH": { name: "高雄", coords: [22.5771, 120.3500], rwys: { "09": 90, "27": 270 } },
    "RCNN": { name: "台南", coords: [22.9507, 120.2058], rwys: { "18R": 180, "36L": 360 } }
};

let map, marker, patternLine, currentData = null, trafficSide = 'L';

function initMap() {
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    // 使用最穩定的 OSM 來源
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternLine = L.polyline([], { color: '#4dabf7', weight: 3, dashArray: '5, 8' }).addTo(map);
}

function switchTab(n) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab' + n).classList.add('active');
    document.querySelectorAll('.tab-btn')[n-1].classList.add('active');
    if(n === 1) setTimeout(() => map.invalidateSize(), 300);
}

// 初始化選單
function populateAirports() {
    const sel = document.getElementById('airportSelect');
    for(let icao in airportDB) {
        sel.add(new Option(`${icao} - ${airportDB[icao].name}`, icao));
    }
}

async function fetchMetar() {
    const icao = document.getElementById('airportSelect').value;
    const mock = `${icao} 010500Z 07014KT 9999 FEW015 SCT080 22/15 Q1013 NOSIG`;
    document.getElementById('rawMetar').innerText = mock;
    decode(mock, icao);
}

function decode(raw, icao) {
    const wind = raw.match(/(\d{3})(\d{2,3})KT/);
    const dir = wind ? parseInt(wind[1]) : 0;
    const spd = wind ? parseInt(wind[2]) : 0;
    const ap = airportDB[icao];
    let best = "--", minD = 180;

    for(let r in ap.rwys) {
        let d = Math.abs(dir - ap.rwys[r]); if(d>180) d=360-d;
        if(d < minD) { minD = d; best = r; }
    }

    const rad = (minD * Math.PI) / 180;
    currentData = { icao, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };

    document.getElementById('estRunway').innerText = best;
    document.getElementById('valHead').innerText = currentData.hw;
    document.getElementById('valCross').innerText = currentData.cw;
    document.getElementById('vis').innerText = "10km+";
    document.getElementById('qnh').innerText = "1013 hPa";
    document.getElementById('clouds').innerText = "FEW 1500ft, SCT 8000ft";
    document.getElementById('rmk').innerText = "NOSIG - 未來兩小時天氣無顯著變化";
    
    map.setView(ap.coords, 14);
    marker.setLatLng(ap.coords);
    drawPatternOnMap(icao, best);
}

function drawPatternOnMap(icao, rwy) {
    const ap = airportDB[icao];
    const hdg = ap.rwys[rwy];
    const lat = ap.coords[0], lon = ap.coords[1];
    const side = trafficSide === 'L' ? -1 : 1;
    const d = 0.012; // 距離常數

    const rad = (hdg - 90) * Math.PI / 180;
    // 簡易長方形五邊座標計算
    const p1 = [lat + Math.cos(rad)*d*1.5, lon + Math.sin(rad)*d*1.5]; // Final point
    const p2 = [lat - Math.cos(rad)*d*1.5, lon - Math.sin(rad)*d*1.5]; // Upwind point
    const p3 = [p2[0] + Math.cos(rad + Math.PI/2*side)*d, p2[1] + Math.sin(rad + Math.PI/2*side)*d]; // Downwind start
    const p4 = [p1[0] + Math.cos(rad + Math.PI/2*side)*d, p1[1] + Math.sin(rad + Math.PI/2*side)*d]; // Base start

    patternLine.setLatLngs([p1, p2, p3, p4, p1]);
}

function setTraffic(s) {
    trafficSide = s;
    document.getElementById('btnL').classList.toggle('active', s==='L');
    document.getElementById('btnR').classList.toggle('active', s==='R');
    updateTab2();
}

function transferToTab2() {
    const sel = document.getElementById('tab2Runway');
    sel.innerHTML = "";
    for(let r in airportDB[currentData.icao].rwys) {
        let opt = new Option("RWY " + r, r);
        if(r === currentData.best) opt.selected = true;
        sel.add(opt);
    }
    updateTab2();
    switchTab(2);
}

function updateTab2() {
    const rwy = document.getElementById('tab2Runway').value;
    const hdg = airportDB[currentData.icao].rwys[rwy];
    const side = trafficSide === 'L' ? -1 : 1;
    
    // 更新羅盤
    document.getElementById('rwyStrip').style.transform = `translate(-50%, -50%) rotate(${hdg}deg)`;
    document.getElementById('windArrow').style.transform = `translate(-50%, -100%) rotate(${currentData.dir}deg)`;

    // WCA 計算 (TAS 90kt)
    const legs = [
        { name: "Upwind/Final", t: hdg },
        { name: "Crosswind", t: (hdg + 270*side + 360) % 360 },
        { name: "Downwind", t: (hdg + 180) % 360 },
        { name: "Base", t: (hdg + 90*side + 360) % 360 }
    ];

    let html = "";
    legs.forEach(l => {
        const angle = (currentData.dir - l.t) * Math.PI / 180;
        const wca = Math.round(Math.asin((currentData.spd * Math.sin(angle)) / 90) * 180 / Math.PI);
        const fh = (l.t + wca + 360) % 360;
        html += `<tr><td>${l.name}</td><td>${l.t}°</td><td style="color:#ff4757">${wca>0?'+':''}${wca}°</td><td><b>${fh}°</b></td></tr>`;
    });
    document.getElementById('wcaBody').innerHTML = html;
    drawPatternOnMap(currentData.icao, rwy);
}

window.onload = () => {
    initMap();
    populateAirports();
    fetchMetar();
};
</script>
</body>
</html>
