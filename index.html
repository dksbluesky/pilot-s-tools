<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor Full Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --dim: #94a3b8; --green: #4ade80; --red: #fb7185; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 480px; margin: 0 auto; }
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .label-sm { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; font-weight: bold; }
        .rwy-id { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }
        .v-line { width: 2px; height: 50px; background: #475569; }
        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.82rem; line-height: 1.4; background: #000; padding: 10px; border-radius: 6px; border-left: 4px solid var(--green); margin-top: 8px; white-space: pre-wrap; }
        .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
        .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; box-sizing: border-box; border-radius: 3px; }
        .rwy-num { display: inline-block; color: white; font-size: 11px; font-weight: bold; font-family: monospace; transition: transform 0.3s; }
        .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; }
        #map { height: 260px; border-radius: 12px; margin-top: 10px; background: #000; border: 1px solid #444; }
        select { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; }
        .side-toggle { display: flex; gap: 8px; margin-top: 10px; }
        .side-toggle button { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #334155; color: white; font-weight: bold; cursor: pointer; }
        .side-toggle button.active { background: #f59e0b; color: #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">Ê©üÂ†¥Ë≥áË®ä</button>
        <button class="tab-btn" onclick="switchTab(2)">Ëµ∑ÈôçË®àÁÆó</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card"><span class="label-sm">ICAO Ê©üÂ†¥ÈÅ∏Êìá</span><select id="apSelect" onchange="update()"></select></div>
        <div class="card"><span class="label-sm">ÂéüÂßãÈõªÁ¢º RAW DATA</span><div id="rawView" class="raw-text">Loading...</div></div>
        <div class="card">
            <span class="label-sm">È†ê‰º∞Ë∑ëÈÅì EST. RUNWAY</span>
            <div class="est-row" style="display:flex; align-items:center; gap:20px; margin-top:8px;">
                <div id="estRwy" class="rwy-id">--</div>
                <div class="v-line"></div>
                <div style="font-size: 0.9rem">
                    <div>Head: <span id="hWind" style="color:var(--green); font-weight:bold">0</span> KT</div>
                    <div>Cross: <span id="cWind" style="color:var(--green); font-weight:bold">0</span> KT</div>
                </div>
            </div>
        </div>
        <div class="card"><span class="label-sm">‰∫îÈÇäËà™Á∑öÊ†°Ê∫ñ MAP ALIGNMENT</span><div id="map"></div></div>
        <button onclick="transfer()" style="width:100%; padding:18px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ÂÇ≥ÈÄÅËá≥Ë®àÁÆóÈ†ÅÈù¢ ‚ûî</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <select id="tab2Rwy" onchange="refreshTab2()" style="margin-bottom:10px"></select>
            <div class="side-toggle"><button id="bL" class="active" onclick="setSide('L')">LEFT Traffic</button><button id="bR" onclick="setSide('R')">RIGHT Traffic</button></div>
        </div>
        <div class="card" style="text-align:center">
            <div class="compass-wrap">
                <svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg>
                <div id="rwyBar" class="rwy-bar"><span id="n1" class="rwy-num">--</span><span id="n2" class="rwy-num">--</span></div>
                <div id="windPtr" class="wind-ptr"><svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;"><path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" /></svg></div>
            </div>
        </div>
        <div class="card"><table style="width:100%; font-size: 0.95rem; border-collapse: collapse;"><tbody id="wcaList"></tbody></table></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const airportDB = {
    // üáπüáº Âè∞ÁÅ£
    "RCTP": { name: "Ê°ÉÂúí Taoyuan", lat: 25.0797, lon: 121.2342, rwys: { "05L": 52.7, "05R": 52.7, "23L": 232.7, "23R": 232.7 }, variation: -4.5 },
    "RCSS": { name: "ÊùæÂ±± Songshan", lat: 25.0697, lon: 121.5525, rwys: { "10": 97.5, "28": 277.5 }, variation: -4.5 },
    "RCKH": { name: "È´òÈõÑ Kaohsiung", lat: 22.5771, lon: 120.3500, rwys: { "09": 86.8, "27": 266.8 }, variation: -3.2 },
    "RCMQ": { name: "Âè∞‰∏≠ Taichung", lat: 24.2582, lon: 120.6203, rwys: { "18": 178, "36": 358 }, variation: -4.2 },
    "RCNN": { name: "Âè∞Âçó Tainan", lat: 22.9507, lon: 120.2058, rwys: { "18L": 178, "18R": 178, "36L": 358, "36R": 358 }, variation: -3.5 },
    "RCBS": { name: "ÈáëÈñÄ Kinmen", lat: 24.4297, lon: 118.3586, rwys: { "06": 60, "24": 240 }, variation: -4.0 },
    "RCQC": { name: "ÊæéÊπñ Penghu", lat: 23.5681, lon: 119.6281, rwys: { "02": 20, "20": 200 }, variation: -3.5 },
    // üåè Ê∏ØÊæ≥/‰∏≠Âúã
    "VHHH": { name: "È¶ôÊ∏Ø Hong Kong", lat: 22.3089, lon: 113.9145, rwys: { "07L": 73, "07R": 73, "25L": 253, "25R": 253 }, variation: -2.3 },
    "VMMC": { name: "Êæ≥ÈñÄ Macau", lat: 22.1495, lon: 113.5915, rwys: { "16": 160, "34": 340 }, variation: -2.3 },
    "ZSPD": { name: "‰∏äÊµ∑Êµ¶Êù± Pudong", lat: 31.1433, lon: 121.8052, rwys: { "16L": 158, "34R": 338 }, variation: -6.0 },
    "ZBAA": { name: "Âåó‰∫¨È¶ñÈÉΩ Beijing", lat: 40.0799, lon: 116.6031, rwys: { "01": 11, "19": 191 }, variation: -8.0 },
    // JPKR Êó•Êú¨/ÈüìÂúã
    "RJBB": { name: "Â§ßÈò™ÈóúË•ø Kansai", lat: 34.4347, lon: 135.2441, rwys: { "06L": 62, "24R": 242 }, variation: -7.5 },
    "RJTT": { name: "Êù±‰∫¨ÁæΩÁî∞ Haneda", lat: 35.5494, lon: 139.7798, rwys: { "34L": 337, "16R": 157 }, variation: -7.8 },
    "RJAA": { name: "Êù±‰∫¨ÊàêÁî∞ Narita", lat: 35.7647, lon: 140.3863, rwys: { "16L": 156, "34R": 336 }, variation: -7.8 },
    "RKSI": { name: "È¶ñÁàæ‰ªÅÂ∑ù Incheon", lat: 37.4602, lon: 126.4407, rwys: { "15L": 154, "33R": 334 }, variation: -8.5 },
    // üå¥ Êù±Âçó‰∫û
    "WSSS": { name: "Êñ∞Âä†Âù° Singapore", lat: 1.3644, lon: 103.9915, rwys: { "02L": 20, "20R": 200 }, variation: 0.2 },
    "VTBS": { name: "ÊõºË∞∑ Suvarnabhumi", lat: 13.6931, lon: 100.7501, rwys: { "01L": 11, "19R": 191 }, variation: -0.5 },
    "RPLL": { name: "È¶¨Â∞ºÊãâ Manila", lat: 14.5082, lon: 121.0197, rwys: { "06": 61, "24": 241 }, variation: -1.0 },
    // USEU Ê≠êÁæé
    "KJFK": { name: "Á¥êÁ¥Ñ JFK", lat: 40.6413, lon: -73.7781, rwys: { "04L": 44, "22R": 224 }, variation: -12.5 },
    "KLAX": { name: "Ê¥õÊùâÁ£Ø LAX", lat: 33.9416, lon: -118.4085, rwys: { "06L": 69, "24R": 249 }, variation: 11.5 },
    "EGLL": { name: "ÂÄ´Êï¶ Heathrow", lat: 51.4700, lon: -0.4543, rwys: { "09L": 90, "27R": 270 }, variation: 1.0 },
    "LFPG": { name: "Â∑¥Èªé CDG", lat: 49.0097, lon: 2.5479, rwys: { "08L": 86, "26R": 266 }, variation: 2.0 }
};

const groups = [
    { label: "üáπüáº Âè∞ÁÅ£ Taiwan", ids: ["RCTP", "RCSS", "RCKH", "RCMQ", "RCNN", "RCBS", "RCQC"] },
    { label: "üåè Ê∏ØÊæ≥/‰∏≠Âúã East Asia", ids: ["VHHH", "VMMC", "ZSPD", "ZBAA"] },
    { label: "JPKR Êó•Êú¨/ÈüìÂúã Japan/Korea", ids: ["RJBB", "RJTT", "RJAA", "RKSI"] },
    { label: "üå¥ Êù±Âçó‰∫û SE Asia", ids: ["WSSS", "VTBS", "RPLL"] },
    { label: "USEU Ê≠êÁæé US/EU", ids: ["KJFK", "KLAX", "EGLL", "LFPG"] }
];

let map, marker, patternOverlay, currentData = null, side = 'L';

function init() {
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternOverlay = L.polyline([], { color: '#38bdf8', weight: 3, dashArray: '10, 10' }).addTo(map);
    const sel = document.getElementById('apSelect');
    groups.forEach(g => {
        let grp = document.createElement('optgroup'); grp.label = g.label;
        g.ids.forEach(id => grp.appendChild(new Option(`${id} - ${airportDB[id].name}`, id)));
        sel.appendChild(grp);
    });
    drawCompass(); update();
}

function drawCompass() {
    const svg = document.getElementById('compSvg'), labels = { 0:'N', 90:'E', 180:'S', 270:'W' };
    let h = '';
    for(let i=0; i<360; i+=10) {
        let isL = i % 30 === 0, x1 = 100 + Math.sin(i*Math.PI/180) * (isL ? 82 : 88), y1 = 100 - Math.cos(i*Math.PI/180) * (isL ? 82 : 88);
        let x2 = 100 + Math.sin(i*Math.PI/180) * 96, y2 = 100 - Math.cos(i*Math.PI/180) * 96;
        h += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="${isL?2:1}" />`;
        if(i % 90 === 0) h += `<text x="${100+Math.sin(i*Math.PI/180)*70}" y="${100-Math.cos(i*Math.PI/180)*70}" fill="white" font-size="14" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${labels[i]}</text>`;
    }
    svg.innerHTML = h;
}

function update() {
    const id = document.getElementById('apSelect').value, ap = airportDB[id];
    // ‰ΩøÁî®ÊïôÂÆòË¶ÅÊ±ÇÁöÑÁúüÂØ¶Ê†ºÂºèÈõªÁ¢º
    const raw = `${id} 010500Z 10007KT 050V140 9999 FEW012 SCT025 BKN035 17/14 Q1018 NOSIG RMK A3006`;
    document.getElementById('rawView').innerText = raw;
    const wind = raw.match(/(\d{3})(\d{2,3})KT/), dir = parseInt(wind[1]), spd = parseInt(wind[2]);
    let best = "", minD = 180;
    for(let r in ap.rwys) {
        let diff = Math.abs(dir - ap.rwys[r]); if(diff > 180) diff = 360 - diff;
        if(diff < minD) { minD = diff; best = r; }
    }
    const rad = (minD * Math.PI) / 180;
    currentData = { id, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };
    document.getElementById('estRwy').innerText = best;
    document.getElementById('hWind').innerText = currentData.hw;
    document.getElementById('cWind').innerText = currentData.cw;
    map.setView([ap.lat, ap.lon], 14); marker.setLatLng([ap.lat, ap.lon]);
    drawPattern(id, best);
}

function drawPattern(id, rwy) {
    const ap = airportDB[id], s = side === 'L' ? -1 : 1;
    // Á£ÅËΩâÁúüÔºåÂ∞çÈΩä OSM
    const trueHdg = ap.rwys[rwy] + ap.variation;
    const latF = 1 / 60, lonF = latF / Math.cos(ap.lat * Math.PI / 180);
    const toRad = Math.PI / 180, rH = (90 - trueHdg) * toRad, rS = (90 - (trueHdg + 90 * s)) * toRad;
    const move = (p, ang, dist) => [p[0] + Math.sin(ang) * dist * latF, p[1] + Math.cos(ang) * dist * lonF];
    const c = [ap.lat, ap.lon];
    const p1 = move(c, rH, 1.8), p2 = move(c, rH, -1.8), p3 = move(p2, rS, 1.2), p4 = move(p1, rS, 1.2);
    patternOverlay.setLatLngs([p1, p2, p3, p4, p1]);
}

function transfer() {
    const s = document.getElementById('tab2Rwy'); s.innerHTML = "";
    for(let r in airportDB[currentData.id].rwys) { let o = new Option("RWY " + r, r); if(r === currentData.best) o.selected = true; s.add(o); }
    refreshTab2(); switchTab(2);
}

function refreshTab2() {
    const r = document.getElementById('tab2Rwy').value, ap = airportDB[currentData.id];
    const magH = ap.rwys[r], rot = magH - 90;
    document.getElementById('rwyBar').style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
    const n1 = document.getElementById('n1'), n2 = document.getElementById('n2');
    n1.innerText = r; n2.innerText = (parseInt(r) > 18 ? parseInt(r)-18 : parseInt(r)+18).toString().padStart(2,'0');
    // Êï∏Â≠óÈò≤ÂÄíÁΩÆ‰øÆÊ≠£
    n1.style.transform = `rotate(${-rot}deg)`; n2.style.transform = `rotate(${-rot}deg)`;
    document.getElementById('windPtr').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;
    const legs = [{n:"Upwind",t:magH},{n:"Cross",t:(magH+270*(side==='L'?-1:1)+360)%360},{n:"Downwind",t:(magH+180)%360},{n:"Base",t:(magH+90*(side==='L'?-1:1)+360)%360}];
    let h = ""; legs.forEach(l => {
        const a = (currentData.dir - l.t) * Math.PI / 180, wca = Math.round(Math.asin((currentData.spd * Math.sin(a)) / 90) * 180 / Math.PI);
        h += `<tr style="border-bottom:1px solid #334151"><td style="padding:12px 8px">${l.n}</td><td align="center">${Math.round(l.t)}¬∞</td><td align="center" style="color:var(--red)">${wca>0?'+':''}${wca}¬∞</td><td align="right"><b>${((l.t+wca+360)%360).toString().padStart(3,'0')}¬∞</b></td></tr>`;
    });
    document.getElementById('wcaList').innerHTML = h;
    drawPattern(currentData.id, r);
}

function setSide(s) { side = s; document.getElementById('bL').className = s==='L'?'active':''; document.getElementById('bR').className = s==='R'?'active':''; refreshTab2(); }
function switchTab(n) { document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab'+n).classList.add('active'); document.querySelectorAll('.tab-btn')[n-1].classList.add('active'); if(n===1) setTimeout(() => map.invalidateSize(), 300); }
window.onload = init;
</script>
</body>
</html>
