<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket METAR Pro | Dennis @ TNN</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #0b1426; --card: #162235; --border: #1e293b;
            --accent: #3b82f6; --vfr: #22c55e; --text: #ffffff;
            --dim: #94a3b8; --warn: #f59e0b;
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Tab Navigation */
        .tab-bar { display: flex; background: #111d2f; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: var(--dim); font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .tab-btn.active { color: var(--text); border-bottom: 3px solid var(--accent); background: #1e293b; }

        .content { flex: 1; overflow-y: auto; padding: 12px; }
        .page { display: none; }
        .page.active { display: block; }

        /* Card Styles 100% Matching Screenshots */
        .card { background: var(--card); border-radius: 16px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); }
        .card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        select, textarea, input { 
            width: 100%; background: #0f172a; border: 1px solid var(--border); 
            color: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 1rem;
        }

        .airport-header { display: flex; justify-content: space-between; align-items: center; }
        .badge { background: var(--vfr); color: #000; padding: 2px 10px; border-radius: 20px; font-weight: 800; font-size: 0.75rem; }
        
        /* Innovation Compass Dial */
        .compass-container { position: relative; width: 100px; height: 100px; margin: 0 auto 10px; }
        .compass-dial { width: 100%; height: 100%; border: 2px solid #334155; border-radius: 50%; position: relative; }
        .compass-needle { 
            position: absolute; top: 10%; left: 50%; width: 0; height: 0; 
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 40px solid #ef4444; transform-origin: 50% 100%;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .north-label { position: absolute; top: -5px; left: 45%; font-size: 10px; color: var(--dim); }

        .val-num { font-size: 1.6rem; font-weight: bold; margin: 5px 0; }
        .val-unit { font-size: 0.7rem; color: var(--dim); }

        /* Map Container */
        #patternMap { width: 100%; height: 300px; border-radius: 12px; margin-top: 15px; border: 1px solid var(--border); }

        .btn-primary { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        .btn-sync { background: #334155; color: white; border: none; padding: 8px; border-radius: 6px; margin-top: 10px; cursor: pointer; width: 100%; font-size: 0.8rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 0.7rem; color: var(--dim); padding: 8px; border-bottom: 1px solid var(--border); }
        td { padding: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="showPage('metar-page')">âœˆï¸ METAR Dashboard</button>
        <button class="tab-btn" onclick="showPage('pattern-page')">ğŸ§­ Pattern Navigator</button>
    </div>

    <div class="content">
        <div id="metar-page" class="page active">
            <select id="airportSelect" onchange="handleAirportChange()">
                <optgroup label="ğŸ‡¹ğŸ‡¼ å°ç£ Taiwan">
                    <option value="RCTP">RCTP - æ¡ƒåœ’ Taoyuan</option>
                    <option value="RCSS">RCSS - æ¾å±± Songshan</option>
                    <option value="RCKH">RCKH - é«˜é›„ Kaohsiung</option>
                    <option value="RCMQ">RCMQ - å°ä¸­ Taichung</option>
                    <option value="RCNN" selected>RCNN - å°å— Tainan</option>
                    <option value="RCBS">RCBS - é‡‘é–€ Kinmen</option>
                    <option value="RCQC">RCQC - æ¾æ¹– Penghu</option>
                </optgroup>
                <optgroup label="ğŸŒ æ¸¯æ¾³/ä¸­åœ‹ East Asia">
                    <option value="VHHH">VHHH - é¦™æ¸¯ Hong Kong</option>
                    <option value="VMMC">VMMC - æ¾³é–€ Macau</option>
                    <option value="ZSPD">ZSPD - ä¸Šæµ·æµ¦æ± Pudong</option>
                    <option value="ZBAA">ZBAA - åŒ—äº¬é¦–éƒ½ Beijing</option>
                </optgroup>
                <optgroup label="ğŸš€ å…¶ä»–åœ°å€">
                    <option value="MANUAL">ğŸ–Šï¸ æ‰‹å‹•è¼¸å…¥ (Manual Input)...</option>
                </optgroup>
            </select>

            <div class="card">
                <div class="airport-header">
                    <h2 id="disp-icao" style="margin:0">RCNN</h2>
                    <span class="badge">VFR</span>
                </div>
                <textarea id="metarInput" rows="3">RCNN 010330Z 36011KT 9999 FEW012 SCT080 25/15 Q1015 NOSIG RMK A2999</textarea>
                <button class="btn-primary" onclick="parseAll()">è§£æ METAR</button>
                <button class="btn-sync" onclick="syncToPattern()">â¡ï¸ å‚³é€åˆ°èˆªç·šè¨ˆç®— (Tab 2)</button>
            </div>

            <div class="card-row">
                <div class="card" style="text-align:center;">
                    <span class="val-unit">é¢¨é€Ÿ WIND</span>
                    <div class="compass-container">
                        <div class="north-label">N</div>
                        <div class="compass-dial"><div id="needle" class="compass-needle"></div></div>
                    </div>
                    <div class="val-num"><span id="wind-dir">360</span>Â° / <span id="wind-spd">11</span><span class="val-unit">KT</span></div>
                </div>
                <div class="card" style="text-align:center;">
                    <span class="val-unit">èƒ½è¦‹åº¦ VIS</span>
                    <div class="val-num" style="margin-top:30px;">10km+</div>
                    <span class="val-unit">Meters / SM</span>
                </div>
            </div>

            <div class="card">
                <div class="card-row">
                    <div><span class="val-unit">TEMP</span><div class="val-num" style="color:var(--warn)" id="temp-val">25Â°C</div></div>
                    <div><span class="val-unit">QNH</span><div class="val-num" id="qnh-val">1015</div></div>
                </div>
            </div>
        </div>

        <div id="pattern-page" class="page">
            <div class="card">
                <div class="card-row">
                    <div><label class="val-unit">ä½¿ç”¨è·‘é“ RWY</label><input type="number" id="pat-rwy" value="36"></div>
                    <div><label class="val-unit">ç©ºé€Ÿ TAS (KT)</label><input type="number" id="pat-tas" value="90"></div>
                </div>
                <button class="btn-primary" onclick="updatePattern()">å…¨é¢åŸ·è¡Œèˆªç·šåœ°åœ–è¨ˆç®—</button>
            </div>

            <div class="card">
                <table>
                    <thead><tr><th>èˆªæ®µ</th><th>TRK</th><th>HDG</th></tr></thead>
                    <tbody id="pat-table"></tbody>
                </table>
            </div>

            <div id="patternMap"></div>
            <div id="pat-note" class="card" style="margin-top:10px; font-size:0.8rem; color:var(--warn);"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        const airportCoords = { "RCNN": [22.95, 120.20], "RCTP": [25.07, 121.23], "RCSS": [25.06, 121.55] };

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'pattern-page') setTimeout(() => map.invalidateSize(), 200);
        }

        function handleAirportChange() {
            const icao = document.getElementById('airportSelect').value;
            if(icao !== 'MANUAL') document.getElementById('disp-icao').innerText = icao;
        }

        function parseAll() {
            const raw = document.getElementById('metarInput').value;
            const wind = raw.match(/(\d{3})(\d{2,3})KT/);
            if(wind) {
                const dir = parseInt(wind[1]);
                document.getElementById('wind-dir').innerText = dir;
                document.getElementById('wind-spd').innerText = wind[2];
                document.getElementById('needle').style.transform = `translateX(-50%) rotate(${dir}deg)`;
            }
            alert("METAR è§£æèˆ‡è½‰ç›¤åŒæ­¥å®Œæˆï¼");
        }

        function syncToPattern() {
            const dir = document.getElementById('wind-dir').innerText;
            document.getElementById('pat-rwy').value = Math.round(dir/10);
            showPage('pattern-page');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            updatePattern();
        }

        function updatePattern() {
            const rwyHdg = parseInt(document.getElementById('pat-rwy').value) * 10;
            const tas = parseInt(document.getElementById('pat-tas').value);
            const wd = parseInt(document.getElementById('wind-dir').innerText);
            const ws = parseInt(document.getElementById('wind-spd').innerText);
            
            const legs = [
                { n: "ä¸€é‚Š", t: rwyHdg }, { n: "äºŒé‚Š", t: (rwyHdg-90+360)%360 },
                { n: "ä¸‰é‚Š", t: (rwyHdg-180+360)%360 }, { n: "å››é‚Š", t: (rwyHdg-270+360)%360 }, { n: "äº”é‚Š", t: rwyHdg }
            ];

            let html = "";
            legs.forEach(l => {
                let wca = Math.asin((ws/tas) * Math.sin((wd-l.t)*Math.PI/180)) * 180/Math.PI;
                html += `<tr><td>${l.n}</td><td>${l.t}Â°</td><td style="color:var(--warn)">${Math.round((l.t+wca+360)%360)}Â°</td></tr>`;
            });
            document.getElementById('pat-table').innerHTML = html;
            drawMap(rwyHdg);
        }

        function drawMap(hdg) {
            const icao = document.getElementById('airportSelect').value;
            const center = airportCoords[icao] || [22.95, 120.20];
            if(!map) {
                map = L.map('patternMap').setView(center, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            map.setView(center, 13);
            // ç°¡åŒ–ç¤ºç¯„ï¼šåœ¨åœ°åœ–ä¸Šç•«ä¸€å€‹ç¤ºæ„çŸ©å½¢ç·š
            L.circle(center, {radius: 500}).addTo(map).bindPopup("Airport Center").openPopup();
            document.getElementById('pat-note').innerText = "ğŸ’¡ æ•™å®˜ç­†è¨˜ï¼šåœ°åœ–å·²å®šä½è‡³æ©Ÿå ´ï¼Œèˆªç·šè·¯å¾‘å·²æ ¹æ“šè·‘é“ " + hdg + "Â° è‡ªå‹•é©é…ã€‚";
        }
        
        window.onload = () => { handleAirportChange(); parseAll(); };
    </script>
</body>
</html>
