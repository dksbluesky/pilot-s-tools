<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-color: #1a1c23;
            --card-bg: #242731;
            --accent-blue: #4dabf7;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --highlight: #51cf66;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
        }

        .container { max-width: 600px; margin: 0 auto; }

        /* Tab System */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 12px; background: #333; border: none;
            color: white; cursor: pointer; border-radius: 8px 8px 0 0;
        }
        .tab-btn.active { background: var(--accent-blue); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* UI Components */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        select, button {
            width: 100%; padding: 12px; border-radius: 6px;
            border: 1px solid #444; background: #2d303a; color: white; margin-top: 10px;
        }

        .raw-data {
            font-family: 'Courier New', monospace;
            color: var(--highlight);
            font-weight: bold;
            font-size: 1.1em;
            word-break: break-all;
            border-left: 4px solid var(--highlight);
            padding-left: 10px;
        }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { background: #2d303a; padding: 10px; border-radius: 6px; }
        .label { font-size: 0.8em; color: var(--text-dim); display: block; }
        .value { font-size: 1.2em; font-weight: bold; }

        /* Compass */
        .compass-box {
            position: relative; width: 150px; height: 150px;
            margin: 20px auto; border: 2px solid #555; border-radius: 50%;
        }
        .compass-needle {
            position: absolute; top: 50%; left: 50%;
            width: 4px; height: 60px; background: red;
            transform-origin: bottom center; transition: 0.5s;
        }
        .runway-line {
            position: absolute; top: 50%; left: 50%;
            width: 80%; height: 2px; background: white;
            transform-origin: center; opacity: 0.5;
        }

        #map { height: 200px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">Tab 1: æ°£è±¡è§£ç¢¼</button>
        <button class="tab-btn" onclick="switchTab(2)">Tab 2: èµ·é™è¨ˆç®—</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card">
            <label>é¸æ“‡æ©Ÿå ´ (ICAO)</label>
            <select id="airportSelect" onchange="fetchMetar()">
                <optgroup label="ğŸ‡¹ğŸ‡¼ å°ç£ Taiwan">
                    <option value="RCTP">RCTP - æ¡ƒåœ’ Taoyuan</option>
                    <option value="RCSS" selected>RCSS - æ¾å±± Songshan</option>
                    <option value="RCKH">RCKH - é«˜é›„ Kaohsiung</option>
                    <option value="RCMQ">RCMQ - å°ä¸­ Taichung</option>
                    <option value="RCNN">RCNN - å°å— Tainan</option>
                    <option value="RCBS">RCBS - é‡‘é–€ Kinmen</option>
                    <option value="RCQC">RCQC - æ¾æ¹– Penghu</option>
                </optgroup>
                <optgroup label="ğŸŒ æ¸¯æ¾³/ä¸­åœ‹ East Asia">
                    <option value="VHHH">VHHH - é¦™æ¸¯ Hong Kong</option>
                    <option value="VMMC">VMMC - æ¾³é–€ Macau</option>
                    <option value="ZSPD">ZSPD - ä¸Šæµ·æµ¦æ± Pudong</option>
                    <option value="ZBAA">ZBAA - åŒ—äº¬é¦–éƒ½ Beijing</option>
                </optgroup>
                <optgroup label="JPKR æ—¥æœ¬/éŸ“åœ‹ Japan/Korea">
                    <option value="RJBB">RJBB - å¤§é˜ªé—œè¥¿ Kansai</option>
                    <option value="RJTT">RJTT - æ±äº¬ç¾½ç”° Haneda</option>
                    <option value="RJAA">RJAA - æ±äº¬æˆç”° Narita</option>
                    <option value="RKSI">RKSI - é¦–çˆ¾ä»å· Incheon</option>
                </optgroup>
                <option value="MANUAL">ğŸ“ æ‰‹å‹•è¼¸å…¥ (Manual Input)...</option>
            </select>
        </div>

        <div class="card">
            <span class="label">RAW METAR</span>
            <div id="rawMetar" class="raw-data">æ­£åœ¨å–å¾—è³‡æ–™...</div>
        </div>

        <div class="card">
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">é ä¼°ä½¿ç”¨è·‘é“</span>
                    <div id="estRunway" class="value" style="color:var(--accent-blue)">--</div>
                </div>
                <div class="info-item">
                    <span class="label">é¢¨åŠ›åˆ†é‡ (KT)</span>
                    <div id="windComp" class="value">H: 0 / C: 0</div>
                </div>
            </div>
            
            <div id="map"></div>

            <div class="info-grid" style="margin-top:15px">
                <div class="info-item"><span class="label">èƒ½è¦‹åº¦</span><div id="vis" class="value">--</div></div>
                <div class="info-item"><span class="label">é›²å±¤</span><div id="clouds" class="value">--</div></div>
                <div class="info-item"><span class="label">QNH</span><div id="qnh" class="value">--</div></div>
                <div class="info-item"><span class="label">æº«åº¦/éœ²é»</span><div id="tempDew" class="value">--</div></div>
            </div>
        </div>
        
        <button onclick="transferToTab2()" style="background: #e67e22;">å‚³é€è³‡æ–™è‡³ Tab 2 â”</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <h3>èµ·é™æ€§èƒ½è¨ˆç®—</h3>
            <label>ä½¿ç”¨è·‘é“ RWY</label>
            <select id="tab2Runway">
                </select>
            
            <div class="compass-box" id="compass">
                <div class="runway-line" id="rwyLine"></div>
                <div class="compass-needle" id="windArrow"></div>
            </div>
            
            <div class="info-grid">
                <div class="info-item"><span class="label">Head/Tail Wind</span><div id="tab2Head" class="value">--</div></div>
                <div class="info-item"><span class="label">Cross Wind</span><div id="tab2Cross" class="value">--</div></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// æ©Ÿå ´è³‡æ–™åº«
const airportDB = {
    "RCSS": { name: "æ¾å±±", coords: [25.0697, 121.5525], rwys: { "10": 100, "28": 280 } },
    "RCTP": { name: "æ¡ƒåœ’", coords: [25.0797, 121.2342], rwys: { "05L": 52, "05R": 52, "23L": 232, "23R": 232 } },
    "RCKH": { name: "é«˜é›„", coords: [22.5771, 120.3500], rwys: { "09": 90, "27": 270 } },
    "VHHH": { name: "é¦™æ¸¯", coords: [22.3089, 113.9145], rwys: { "07L": 71, "07R": 71, "25L": 251, "25R": 251 } }
    // å…¶ä»–æ©Ÿå ´ä¾æ­¤é¡æ¨...
};

let map;
let marker;
let currentMetarData = null;

function initMap() {
    map = L.map('map').setView([25.0697, 121.5525], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
}

function switchTab(n) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab' + n).classList.add('active');
    document.querySelectorAll('.tab-btn')[n-1].classList.add('active');
    if(n === 1) setTimeout(() => map.invalidateSize(), 200);
}

async function fetchMetar() {
    const icao = document.getElementById('airportSelect').value;
    const data = airportDB[icao];
    
    // æ›´æ–°åœ°åœ–
    if(data) {
        map.setView(data.coords, 13);
        marker.setLatLng(data.coords);
    }

    // æ¨¡æ“¬ METAR API æŠ“å– (å¯¦éš›é–‹ç™¼æ™‚æ›æˆæ•™å®˜çš„ API)
    const mockMetar = `${icao} 010430Z 09012KT 9999 FEW012 SCT080 18/12 Q1013 NOSIG`;
    document.getElementById('rawMetar').innerText = mockMetar;
    parseMetar(mockMetar, icao);
}

function parseMetar(raw, icao) {
    const windMatch = raw.match(/(\d{3})(\d{2,3})KT/);
    const windDir = windMatch ? parseInt(windMatch[1]) : 0;
    const windSpd = windMatch ? parseInt(windMatch[2]) : 0;
    
    // è·‘é“è¨ˆç®—é‚è¼¯
    const airport = airportDB[icao];
    let bestRwy = "--";
    let minDiff = 180;

    if(airport) {
        for (let rwy in airport.rwys) {
            let diff = Math.abs(windDir - airport.rwys[rwy]);
            if (diff > 180) diff = 360 - diff;
            if (diff < minDiff) {
                minDiff = diff;
                bestRwy = rwy;
            }
        }
    }

    // è¨ˆç®—åˆ†é‡
    const angleRad = (minDiff * Math.PI) / 180;
    const hw = Math.round(windSpd * Math.cos(angleRad));
    const cw = Math.round(windSpd * Math.sin(angleRad));

    document.getElementById('estRunway').innerText = bestRwy;
    document.getElementById('windComp').innerText = `H: ${hw} / C: ${cw}`;
    document.getElementById('vis').innerText = "10km+";
    document.getElementById('clouds').innerText = "FEW 1200ft";
    document.getElementById('qnh').innerText = "1013 hPa";
    document.getElementById('tempDew').innerText = "18Â°C / 12Â°C";
    
    currentMetarData = { icao, bestRwy, windDir, windSpd, hw, cw };
}

function transferToTab2() {
    if(!currentMetarData) return;
    
    const icao = currentMetarData.icao;
    const airport = airportDB[icao];
    const rwySelect = document.getElementById('tab2Runway');
    
    // æ›´æ–°ä¸‹æ‹‰é¸å–®
    rwySelect.innerHTML = "";
    for (let rwy in airport.rwys) {
        let opt = document.createElement('option');
        opt.value = rwy;
        opt.innerText = `RWY ${rwy}`;
        if(rwy === currentMetarData.bestRwy) opt.selected = true;
        rwySelect.appendChild(opt);
    }

    updateCompass();
    switchTab(2);
}

function updateCompass() {
    const icao = currentMetarData.icao;
    const rwyKey = document.getElementById('tab2Runway').value;
    const rwyHeading = airportDB[icao].rwys[rwyKey];
    const windDir = currentMetarData.windDir;

    // æ—‹è½‰è·‘é“ç·šèˆ‡é¢¨å‘ç®­é ­
    document.getElementById('rwyLine').style.transform = `translate(-50%, -50%) rotate(${rwyHeading - 90}deg)`;
    document.getElementById('windArrow').style.transform = `translate(-50%, -100%) rotate(${windDir}deg)`;
    
    // é‡æ–°è¨ˆç®—é¸ä¸­è·‘é“çš„åˆ†é‡
    let diff = Math.abs(windDir - rwyHeading);
    if (diff > 180) diff = 360 - diff;
    const angleRad = (diff * Math.PI) / 180;
    const hw = Math.round(currentMetarData.windSpd * Math.cos(angleRad));
    const cw = Math.round(currentMetarData.windSpd * Math.sin(angleRad));

    document.getElementById('tab2Head').innerText = hw + " KT";
    document.getElementById('tab2Cross').innerText = cw + " KT";
}

document.getElementById('tab2Runway').addEventListener('change', updateCompass);

window.onload = () => {
    initMap();
    fetchMetar();
};
</script>

</body>
</html>
