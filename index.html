<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket METAR Pro - Instructor Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --green: #4ade80; --red: #fb7185; }
        body { background-color: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .rwy-id { font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; line-height: 1; }
        .v-line { width: 2px; height: 50px; background: #475569; }
        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.85rem; background: #000; padding: 12px; border-radius: 8px; border-left: 4px solid var(--green); margin-top: 8px; }
        .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
        .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-radius: 3px; }
        .rwy-num { display: inline-block; color: white; font-size: 11px; font-weight: bold; font-family: monospace; transition: transform 0.3s; }
        .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; transition: transform 0.8s ease; }
        #map { height: 260px; border-radius: 12px; background: #111; border: 1px solid #444; margin-top: 10px; }
        select { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; appearance: none; }
        .cloud-row { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .decoder-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; border-bottom: 1px solid #334155; margin-bottom: 4px; display: flex; gap: 10px; }
    </style>
</head>
<body class="p-4">

<div class="container max-w-md mx-auto">
    <div class="flex gap-1 mb-4">
        <button class="tab-btn active" onclick="switchTab(1)">機場資訊</button>
        <button class="tab-btn" onclick="switchTab(2)">起降計算</button>
    </div>

    <div id="tab1" class="tab-content active space-y-4">
        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">Airport Select</span>
            <select id="apSelect" onchange="update()" class="mt-2"></select>
        </div>

        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">Raw METAR (Live)</span>
            <div id="rawView" class="raw-text">正在同步 VATSIM 數據...</div>
        </div>

        <div class="glass-panel p-4 rounded-xl">
            <div class="flex items-center gap-4">
                <div id="estRwy" class="rwy-id">--</div>
                <div class="v-line"></div>
                <div class="text-sm">
                    <div>頂風 Head: <span id="hWind" class="text-green-400 font-bold">0</span> KT</div>
                    <div>側風 Cross: <span id="cWind" class="text-blue-400 font-bold">0</span> KT</div>
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">雲層 CLOUDS</span>
            <div id="cloudBox" class="mt-2"></div>
        </div>

        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">電碼解譯 DECODER</span>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-[10px] text-slate-500">能見度 VIS</div>
                    <div id="visVal" class="font-bold">--</div>
                </div>
                <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-[10px] text-slate-500">氣壓 QNH</div>
                    <div id="qnhVal" class="font-bold">--</div>
                </div>
            </div>
            <div id="decoderBox" class="mt-3 text-sm space-y-1"></div>
        </div>

        <button onclick="transfer()" class="w-full p-4 bg-orange-500 hover:bg-orange-600 text-black font-black rounded-xl transition-all shadow-lg">傳送至計算頁面 ➔</button>
    </div>

    <div id="tab2" class="tab-content space-y-4">
        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">Runway & Traffic Side</span>
            <select id="tab2Rwy" onchange="refreshTab2()" class="mt-2 mb-3"></select>
            <div class="flex gap-2">
                <button id="bL" class="flex-1 p-3 rounded-lg bg-slate-700 font-bold active" onclick="setSide('L')">LEFT Traffic</button>
                <button id="bR" class="flex-1 p-3 rounded-lg bg-slate-700 font-bold" onclick="setSide('R')">RIGHT Traffic</button>
            </div>
        </div>

        <div class="glass-panel p-6 rounded-xl text-center">
            <div class="compass-wrap">
                <svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg>
                <div id="rwyBar" class="rwy-bar">
                    <span id="n1" class="rwy-num">--</span>
                    <span id="n2" class="rwy-num">--</span>
                </div>
                <div id="windPtr" class="wind-ptr">
                    <svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;">
                        <path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-panel p-4 rounded-xl">
            <span class="text-[0.7rem] text-slate-400 uppercase font-bold tracking-widest">WCA Correction (90KT)</span>
            <table class="w-full text-sm mt-2 border-collapse">
                <tbody id="wcaList"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// 專家數據分流與 22 機場清單
const airportDB = {
    "RCTP": { name: "桃園 Taoyuan", lat: 25.0797, lon: 121.2342, rwys: { "05L": {mag:52, true:48.8}, "23R": {mag:232, true:228.8} } },
    "RCSS": { name: "松山 Songshan", lat: 25.0697, lon: 121.5525, rwys: { "10": {mag:100, true:93.5}, "28": {mag:280, true:273.5} } },
    "RCKH": { name: "高雄 Kaohsiung", lat: 22.5771, lon: 120.3500, rwys: { "09": {mag:87, true:84.2}, "27": {mag:267, true:264.2} } },
    "RCMQ": { name: "台中 Taichung", lat: 24.2582, lon: 120.6203, rwys: { "18": {mag:178, true:175}, "36": {mag:360, true:355} } },
    "RCNN": { name: "台南 Tainan", lat: 22.9507, lon: 120.2058, rwys: { "18R": {mag:180, true:176.5}, "36L": {mag:360, true:356.5} } },
    "RCBS": { name: "金門 Kinmen", lat: 24.4297, lon: 118.3586, rwys: { "06": {mag:60, true:55}, "24": {mag:240, true:235} } },
    "RCQC": { name: "澎湖 Penghu", lat: 23.5681, lon: 119.6281, rwys: { "02": {mag:20, true:16.5}, "20": {mag:200, true:196.5} } },
    "VHHH": { name: "香港 Hong Kong", lat: 22.3089, lon: 113.9145, rwys: { "07L": {mag:73, true:71}, "25R": {mag:253, true:251} } },
    "VMMC": { name: "澳門 Macau", lat: 22.1495, lon: 113.5915, rwys: { "16": {mag:160, true:158}, "34": {mag:340, true:338} } },
    "ZSPD": { name: "上海浦東 Pudong", lat: 31.1433, lon: 121.8052, rwys: { "16L": {mag:158, true:152}, "34R": {mag:338, true:332} } },
    "RJTT": { name: "東京羽田 Haneda", lat: 35.5494, lon: 139.7798, rwys: { "34L": {mag:337, true:330}, "16R": {mag:157, true:150} } },
    "WSSS": { name: "新加坡 Singapore", lat: 1.3644, lon: 103.9915, rwys: { "02L": {mag:20, true:20}, "20R": {mag:200, true:200} } }
};

const METAR_DICT = { "NOSIG": "No Significant Change (未來兩小時無顯著變化)", "RMK": "Remarks (備註開始)", "CAVOK": "能見度10km+ 且 5000ft以下無雲" };

let map, marker, patternLine, currentData = null, trafficSide = 'L';

async function update() {
    const id = document.getElementById('apSelect').value;
    const ap = airportDB[id];
    document.getElementById('rawView').innerText = `正在連線至 VATSIM 抓取 ${id}...`;

    try {
        const resp = await fetch(`https://metar.vatsim.net/metar.php?id=${id}&t=${Date.now()}`);
        const raw = await resp.text();
        if(!raw.trim()) throw new Error("No Data");
        document.getElementById('rawView').innerText = raw.trim();

        // 風向、雲層、能見度、氣壓解析
        const wMatch = raw.match(/(\d{3})(\d{2,3})KT/);
        const dir = wMatch ? parseInt(wMatch[1]) : 0, spd = wMatch ? parseInt(wMatch[2]) : 0;
        
        const cloudRegex = /(FEW|SCT|BKN|OVC)(\d{3})/g;
        let cMatch, cHtml = "";
        while ((cMatch = cloudRegex.exec(raw))) {
            cHtml += `<div class="cloud-row"><span><b>${cMatch[1]}</b></span><span>${parseInt(cMatch[2])*100} ft</span></div>`;
        }
        document.getElementById('cloudBox').innerHTML = cHtml || "Sky Clear";

        const visM = raw.match(/\b\d{4}\b/);
        document.getElementById('visVal').innerText = visM ? (visM[0]==="9999"?"10km+":visM[0]+"m") : "N/A";
        const qMatch = raw.match(/Q(\d{4})/);
        document.getElementById('qnhVal').innerText = qMatch ? qMatch[1]+" hPa" : "N/A";

        // Decoder 植入
        let dHtml = "";
        for(let k in METAR_DICT) if(raw.includes(k)) dHtml += `<div class="decoder-item"><b>${k}</b><span>${METAR_DICT[k]}</span></div>`;
        document.getElementById('decoderBox').innerHTML = dHtml;

        let best = "", minD = 180;
        for(let r in ap.rwys) {
            let diff = Math.abs(dir - ap.rwys[r].mag); if(diff > 180) diff = 360 - diff;
            if(diff < minD) { minD = diff; best = r; }
        }
        const rad = (minD * Math.PI) / 180;
        currentData = { id, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };
        document.getElementById('estRwy').innerText = best;
        document.getElementById('hWind').innerText = currentData.hw;
        document.getElementById('cWind').innerText = currentData.cw;
        map.setView([ap.lat, ap.lon], 14); marker.setLatLng([ap.lat, ap.lon]);
        drawMapPattern(id, best);
    } catch (e) {
        document.getElementById('rawView').innerText = "連線失敗，請檢查網路。";
    }
}

function drawMapPattern(id, rwy) {
    const ap = airportDB[id], s = trafficSide === 'L' ? -1 : 1, hdg = ap.rwys[rwy].true;
    const latF = 1 / 60, lonF = latF / Math.cos(ap.lat * Math.PI / 180), toRad = Math.PI / 180;
    const rH = (90 - hdg) * toRad, rS = (90 - (hdg + 90 * s)) * toRad;
    const move = (p, ang, dist) => [p[0] + Math.sin(ang) * dist * latF, p[1] + Math.cos(ang) * dist * lonF];
    const p1 = move([ap.lat, ap.lon], rH, 1.5), p2 = move([ap.lat, ap.lon], rH, -1.5), p3 = move(p2, rS, 1.2), p4 = move(p1, rS, 1.2);
    patternLine.setLatLngs([p1, p2, p3, p4, p1]);
}

function init() {
    const sel = document.getElementById('apSelect');
    groups.forEach(g => {
        let grp = document.createElement('optgroup'); grp.label = g.label;
        g.ids.forEach(id => { if(airportDB[id]) grp.appendChild(new Option(`${id} - ${airportDB[id].name}`, id)); });
        sel.appendChild(grp);
    });
    sel.value = "RCSS";
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternLine = L.polyline([], { color: '#38bdf8', weight: 3, dashArray: '10, 10' }).addTo(map);
    drawCompassScale(); update();
}

function drawCompassScale() {
    const svg = document.getElementById('compSvg'), lbls = { 0:'N', 90:'E', 180:'S', 270:'W' };
    let h = '';
    for(let i=0; i<360; i+=10) {
        let isL = i % 30 === 0, x1 = 100 + Math.sin(i*Math.PI/180) * (isL ? 82 : 88), y1 = 100 - Math.cos(i*Math.PI/180) * (isL ? 82 : 88);
        let x2 = 100 + Math.sin(i*Math.PI/180) * 96, y2 = 100 - Math.cos(i*Math.PI/180) * 96;
        h += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="${isL?2:1}" />`;
        if(i % 90 === 0) h += `<text x="${100+Math.sin(i*Math.PI/180)*72}" y="${100-Math.cos(i*Math.PI/180)*72}" fill="white" font-size="14" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${lbls[i]}</text>`;
    }
    svg.innerHTML = h;
}

function transfer() {
    const s = document.getElementById('tab2Rwy'); s.innerHTML = "";
    for(let r in airportDB[currentData.id].rwys) { let o = new Option("RWY " + r, r); if(r === currentData.best) o.selected = true; s.add(o); }
    refreshTab2(); switchTab(2);
}

function refreshTab2() {
    const r = document.getElementById('tab2Rwy').value, ap = airportDB[currentData.id], magH = ap.rwys[r].mag;
    const rot = magH - 90;
    document.getElementById('rwyBar').style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
    const n1 = document.getElementById('n1'), n2 = document.getElementById('n2');
    n1.innerText = r; n2.innerText = (parseInt(r) > 18 ? parseInt(r)-18 : parseInt(r)+18).toString().padStart(2,'0');
    // 數字頭部向上補正邏輯
    n1.style.transform = `rotate(${-rot}deg)`; n2.style.transform = `rotate(${-rot}deg)`;
    document.getElementById('windPtr').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;
    const legs = [{n:"Upwind",t:magH},{n:"Cross",t:(magH+270*(trafficSide==='L'?-1:1)+360)%360},{n:"Downwind",t:(magH+180)%360},{n:"Base",t:(magH+90*(trafficSide==='L'?-1:1)+360)%360}];
    let h = ""; legs.forEach(l => {
        const a = (currentData.dir - l.t) * Math.PI / 180, wca = Math.round(Math.asin((currentData.spd * Math.sin(a)) / 90) * 180 / Math.PI);
        h += `<tr style="border-bottom:1px solid #334151"><td style="padding:12px 8px">${l.n}</td><td align="center">${Math.round(l.t)}°</td><td align="center" style="color:var(--red)">${wca>0?'+':''}${wca}°</td><td align="right"><b>${((l.t+wca+360)%360).toString().padStart(3,'0')}°</b></td></tr>`;
    });
    document.getElementById('wcaList').innerHTML = h;
    drawMapPattern(currentData.id, r);
}

function setSide(s) { trafficSide = s; document.getElementById('bL').classList.toggle('active', s==='L'); document.getElementById('bR').classList.toggle('active', s==='R'); refreshTab2(); }
function switchTab(n) { document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + n).classList.add('active'); document.querySelectorAll('.tab-btn')[n-1].classList.add('active'); if(n === 1) setTimeout(() => map.invalidateSize(), 300); }

window.onload = init;
</script>
</body>
</html>
