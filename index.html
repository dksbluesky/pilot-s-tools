<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Final Precision Build</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --dim: #94a3b8; --green: #4ade80; --red: #fb7185; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 480px; margin: 0 auto; }
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .label-sm { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; font-weight: bold; }
        /* Pocket METAR UI Clone */
        .rwy-id { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }
        .v-line { width: 2px; height: 50px; background: #475569; }
        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.82rem; line-height: 1.4; background: #000; padding: 10px; border-radius: 6px; border-left: 4px solid var(--green); margin-top: 8px; white-space: pre-wrap; }
        /* Compass with Scale */
        .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
        .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; box-sizing: border-box; border-radius: 3px; }
        .rwy-num { display: inline-block; color: white; font-size: 11px; font-weight: bold; font-family: monospace; transition: transform 0.3s; }
        .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; }
        #map { height: 260px; border-radius: 12px; margin-top: 10px; background: #000; border: 1px solid #444; }
        select { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; }
        .side-toggle { display: flex; gap: 8px; margin-top: 10px; }
        .side-toggle button { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #334155; color: white; font-weight: bold; cursor: pointer; }
        .side-toggle button.active { background: #f59e0b; color: #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">æ©Ÿå ´è³‡è¨Š</button>
        <button class="tab-btn" onclick="switchTab(2)">èµ·é™è¨ˆç®—</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card"><span class="label-sm">ICAO æ©Ÿå ´é¸æ“‡</span><select id="apSelect" onchange="update()"></select></div>
        <div class="card"><span class="label-sm">åŸå§‹é›»ç¢¼ RAW DATA</span><div id="rawView" class="raw-text">Loading...</div></div>
        <div class="card">
            <span class="label-sm">é ä¼°è·‘é“ EST. RUNWAY</span>
            <div style="display:flex; align-items:center; gap:20px; margin-top:8px;">
                <div id="estRwy" class="rwy-id">--</div>
                <div class="v-line"></div>
                <div style="font-size: 0.9rem">
                    <div>é ‚é¢¨ Head: <span id="hWind" style="color:var(--green); font-weight:bold">0</span> KT</div>
                    <div>å´é¢¨ Cross: <span id="cWind" style="color:var(--green); font-weight:bold">0</span> KT</div>
                </div>
            </div>
        </div>
        <div class="card"><span class="label-sm">äº”é‚Šèˆªç·šæ ¡æº– MAP (100% PARALLEL)</span><div id="map"></div></div>
        <button onclick="transfer()" style="width:100%; padding:18px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">å‚³é€è¨ˆç®— â”</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <select id="tab2Rwy" onchange="refreshTab2()" style="margin-bottom:10px"></select>
            <div class="side-toggle">
                <button id="bL" class="active" onclick="setSide('L')">LEFT Traffic</button>
                <button id="bR" onclick="setSide('R')">RIGHT Traffic</button>
            </div>
        </div>
        <div class="card" style="text-align:center">
            <div class="compass-wrap">
                <svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg>
                <div id="rwyBar" class="rwy-bar"><span id="n1" class="rwy-num">--</span><span id="n2" class="rwy-num">--</span></div>
                <div id="windPtr" class="wind-ptr"><svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;"><path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" /></svg></div>
            </div>
        </div>
        <div class="card"><table style="width:100%; font-size: 0.95rem; border-collapse: collapse;"><tbody id="wcaList"></tbody></table></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// å°ˆå®¶ä¿®æ­£ï¼šmag ç”¨æ–¼ WCA/é ‚å´é¢¨è¨ˆç®—ï¼Œtrue ç”¨æ–¼ Leaflet åœ°åœ–ç¹ªåœ–å°é½Š
const airportDB = {
    "RCTP": { name: "æ¡ƒåœ’ Taoyuan", lat: 25.0797, lon: 121.2342, rwys: { "05L": {mag:52, true:48.8}, "23R": {mag:232, true:228.8} } },
    "RCSS": { name: "æ¾å±± Songshan", lat: 25.0697, lon: 121.5525, rwys: { "10": {mag:100, true:93.5}, "28": {mag:280, true:273.5} } },
    "RCKH": { name: "é«˜é›„ Kaohsiung", lat: 22.5771, lon: 120.3500, rwys: { "09": {mag:87, true:84.2}, "27": {mag:267, true:264.2} } },
    "RCMQ": { name: "å°ä¸­ Taichung", lat: 24.2582, lon: 120.6203, rwys: { "18": {mag:178, true:174}, "36": {mag:358, true:354} } },
    "RCNN": { name: "å°å— Tainan", lat: 22.9507, lon: 120.2058, rwys: { "18R": {mag:180, true:176.5}, "36L": {mag:360, true:356.5} } },
    "RCBS": { name: "é‡‘é–€ Kinmen", lat: 24.4297, lon: 118.3586, rwys: { "06": {mag:60, true:56}, "24": {mag:240, true:236} } },
    "RCQC": { name: "æ¾æ¹– Penghu", lat: 23.5681, lon: 119.6281, rwys: { "02": {mag:20, true:16.5}, "20": {mag:200, true:196.5} } },
    "VHHH": { name: "é¦™æ¸¯ Hong Kong", lat: 22.3089, lon: 113.9145, rwys: { "07L": {mag:73, true:71}, "25R": {mag:253, true:251} } },
    "VMMC": { name: "æ¾³é–€ Macau", lat: 22.1495, lon: 113.5915, rwys: { "16": {mag:160, true:158}, "34": {mag:340, true:338} } },
    "ZSPD": { name: "ä¸Šæµ·æµ¦æ± Pudong", lat: 31.1433, lon: 121.8052, rwys: { "16L": {mag:158, true:152}, "34R": {mag:338, true:332} } },
    "ZBAA": { name: "åŒ—äº¬é¦–éƒ½ Beijing", lat: 40.0799, lon: 116.6031, rwys: { "01": {mag:11, true:3}, "19": {mag:191, true:183} } },
    "RJBB": { name: "å¤§é˜ªé—œè¥¿ Kansai", lat: 34.4347, lon: 135.2441, rwys: { "06L": {mag:62, true:55}, "24R": {mag:242, true:235} } },
    "RJTT": { name: "æ±äº¬ç¾½ç”° Haneda", lat: 35.5494, lon: 139.7798, rwys: { "34L": {mag:337, true:330}, "16R": {mag:157, true:150} } },
    "RJAA": { name: "æ±äº¬æˆç”° Narita", lat: 35.7647, lon: 140.3863, rwys: { "16L": {mag:156, true:149}, "34R": {mag:336, true:329} } },
    "RKSI": { name: "é¦–çˆ¾ä»å· Incheon", lat: 37.4602, lon: 126.4407, rwys: { "15L": {mag:154, true:146}, "33R": {mag:334, true:326} } },
    "WSSS": { name: "æ–°åŠ å¡ Singapore", lat: 1.3644, lon: 103.9915, rwys: { "02L": {mag:20, true:20}, "20R": {mag:200, true:200} } },
    "VTBS": { name: "æ›¼è°· Suvarnabhumi", lat: 13.6931, lon: 100.7501, rwys: { "01L": {mag:11, true:11}, "19R": {mag:191, true:191} } },
    "RPLL": { name: "é¦¬å°¼æ‹‰ Manila", lat: 14.5082, lon: 121.0197, rwys: { "06": {mag:61, true:60}, "24": {mag:241, true:240} } },
    "KJFK": { name: "ç´ç´„ JFK", lat: 40.6413, lon: -73.7781, rwys: { "04L": {mag:44, true:57}, "22R": {mag:224, true:237} } },
    "KLAX": { name: "æ´›æ‰ç£¯ LAX", lat: 33.9416, lon: -118.4085, rwys: { "06L": {mag:69, true:58}, "24R": {mag:249, true:238} } },
    "EGLL": { name: "å€«æ•¦ Heathrow", lat: 51.4700, lon: -0.4543, rwys: { "09L": {mag:90, true:89}, "27R": {mag:270, true:269} } },
    "LFPG": { name: "å·´é» CDG", lat: 49.0097, lon: 2.5479, rwys: { "08L": {mag:86, true:84}, "26R": {mag:266, true:264} } }
};

const groups = [
    { label: "ğŸ‡¹ğŸ‡¼ å°ç£ Taiwan", ids: ["RCTP", "RCSS", "RCKH", "RCMQ", "RCNN", "RCBS", "RCQC"] },
    { label: "ğŸŒ æ¸¯æ¾³/ä¸­åœ‹ East Asia", ids: ["VHHH", "VMMC", "ZSPD", "ZBAA"] },
    { label: "JPKR æ—¥æœ¬/éŸ“åœ‹ Japan/Korea", ids: ["RJBB", "RJTT", "RJAA", "RKSI"] },
    { label: "ğŸŒ´ æ±å—äº SE Asia", ids: ["WSSS", "VTBS", "RPLL"] },
    { label: "USEU æ­ç¾ US/EU", ids: ["KJFK", "KLAX", "EGLL", "LFPG"] }
];

let map, marker, patternOverlay, currentData = null, trafficSide = 'L';

function init() {
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternOverlay
