<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor V4</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-dark: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --text: #f1f5f9; --text-dim: #94a3b8; --green: #4ade80; --red: #fb7185;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 480px; margin: 0 auto; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 12px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; }
        .tab-btn.active { background: var(--card-bg); border-bottom: 3px solid var(--accent); opacity: 1; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .label-sm { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

        /* Pocket METAR UI */
        .est-runway-row { display: flex; align-items: center; gap: 24px; margin-top: 8px; }
        .rwy-id { font-size: 3.2rem; font-weight: 900; letter-spacing: -2px; line-height: 1; }
        .v-line { width: 1.5px; height: 45px; background: #475569; }
        .wind-comp { font-size: 0.95rem; }
        .val-num { color: var(--green); font-weight: bold; }

        .raw-text { font-family: 'JetBrains Mono', 'Courier New', monospace; color: var(--green); font-size: 0.85rem; line-height: 1.5; margin-top: 8px; background: #00000044; padding: 8px; border-radius: 4px; border-left: 3px solid var(--green); }

        /* Advanced Compass */
        .compass-wrap { position: relative; width: 220px; height: 220px; margin: 20px auto; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); border-radius: 50%; border: 4px solid #334155; }
        .compass-dial { position: absolute; width: 100%; height: 100%; background: url('https://i.imgur.com/8X8vS7P.png') center/contain; opacity: 0.8; } /* 模擬刻度盤圖案 */
        .compass-tick { position: absolute; width: 100%; height: 100%; top:0; left:0; }
        .rwy-strip-visual { position: absolute; top: 50%; left: 50%; width: 140px; height: 16px; background: #111; border: 1px solid #fff; transform-origin: center; transform: translate(-50%, -50%); z-index: 2; display: flex; justify-content: space-between; padding: 0 5px; box-sizing: border-box; color: #fff; font-size: 10px; align-items: center; border-radius: 2px; }
        .wind-arrow { position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 30px solid var(--red); transform-origin: center 110px; z-index: 3; filter: drop-shadow(0 0 5px rgba(251,113,129,0.5)); }

        #map { height: 240px; border-radius: 8px; margin-top: 10px; background: #000; }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .btn-group button { flex: 1; padding: 10px; border: none; border-radius: 6px; background: #334155; color: white; cursor: pointer; }
        .btn-group button.active { background: #f59e0b; font-weight: bold; }
        select { width: 100%; padding: 12px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">機場資訊</button>
        <button class="tab-btn" onclick="switchTab(2)">航線練習</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card">
            <span class="label-sm">AIRPORT</span>
            <select id="apSelect" onchange="updateData()"></select>
        </div>

        <div class="card">
            <span class="label-sm">RAW METAR</span>
            <div id="rawView" class="raw-text">Loading...</div>
        </div>

        <div class="card">
            <span class="label-sm">EST. RUNWAY</span>
            <div class="est-runway-row">
                <div id="estRwy" class="rwy-id">--</div>
                <div class="v-line"></div>
                <div class="wind-comp">
                    <div>Head: <span id="hWind" class="val-num">0</span> KT</div>
                    <div>Cross: <span id="cWind" class="val-num">0</span> KT</div>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">PATTERN MAP</span>
            <div id="map"></div>
        </div>
        
        <button onclick="transfer()" style="width:100%; padding:16px; background:var(--accent); color:black; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">傳送至五邊計算 ➔</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <span class="label-sm">RUNWAY & TRAFFIC</span>
            <select id="tab2Rwy" onchange="refreshTab2()"></select>
            <div class="btn-group">
                <button id="bL" class="active" onclick="setSide('L')">LEFT TRAFFIC</button>
                <button id="bR" onclick="setSide('R')">RIGHT TRAFFIC</button>
            </div>
        </div>

        <div class="card" style="text-align:center">
            <span class="label-sm">COMPASS (HEADING & WIND)</span>
            <div class="compass-wrap">
                <div id="dial" class="compass-dial"></div>
                <div id="rwyVisual" class="rwy-strip-visual">
                    <span id="num1">10</span><span style="color:#ffffff44">----------</span><span id="num2">28</span>
                </div>
                <div id="windArrow" class="wind-arrow"></div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">WCA CORRECTION (TAS 90KT)</span>
            <table style="width:100%; font-size: 0.9rem; border-collapse: collapse; margin-top:10px;">
                <thead style="color:var(--text-dim)"><tr><th align="left">LEG</th><th align="center">TRACK</th><th align="center">WCA</th><th align="right">HEADING</th></tr></thead>
                <tbody id="wcaList"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const db = {
    "RCSS": { name: "松山", lat: 25.0697, lon: 121.5525, rwys: { "10": 100, "28": 280 } },
    "RCTP": { name: "桃園", lat: 25.0797, lon: 121.2342, rwys: { "05L": 52, "23R": 232 } },
    "RCNN": { name: "台南", lat: 22.9507, lon: 120.2058, rwys: { "18L": 180, "36R": 360 } }
};

let map, marker, pattern, cur = null, side = 'L';

function init() {
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    pattern = L.polyline([], { color: '#38bdf8', weight: 2, dashArray: '5, 10' }).addTo(map);
    
    const sel = document.getElementById('apSelect');
    for(let id in db) sel.add(new Option(id + " - " + db[id].name, id));
    updateData();
}

function updateData() {
    const id = document.getElementById('apSelect').value;
    const ap = db[id];
    // 更真實的電碼模擬
    const mock = `${id} 010500Z 10007KT 050V110 9999 FEW012 SCT020 BKN035 17/14 Q1018 NOSIG RMK A3006`;
    document.getElementById('rawView').innerText = mock;
    
    const wind = mock.match(/(\d{3})(\d{2,3})KT/);
    const dir = parseInt(wind[1]), spd = parseInt(wind[2]);
    
    let best = "", min = 180;
    for(let r in ap.rwys) {
        let diff = Math.abs(dir - ap.rwys[r]); if(diff > 180) diff = 360 - diff;
        if(diff < min) { min = diff; best = r; }
    }
    
    const rad = (min * Math.PI) / 180;
    cur = { id, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };
    
    document.getElementById('estRwy').innerText = best;
    document.getElementById('hWind').innerText = cur.hw;
    document.getElementById('cWind').innerText = cur.cw;
    
    map.setView([ap.lat, ap.lon], 14);
    marker.setLatLng([ap.lat, ap.lon]);
    drawPattern(id, best);
}

function drawPattern(id, rwy) {
    const ap = db[id];
    const hdg = ap.rwys[rwy];
    const lat = ap.lat, lon = ap.lon;
    const s = side === 'L' ? -1 : 1;
    
    // 經緯度偏移計算 (1海里約 0.016 lat)
    const toRad = Math.PI / 180;
    const rH = hdg * toRad;
    const rP = (hdg + 90 * s) * toRad;

    // 定位四個點：1.Final 2.Upwind 3.Downwind Start 4.Base Start
    const p1 = [lat + Math.cos(Math.PI/2 - rH)*0.02, lon + Math.sin(Math.PI/2 - rH)*0.02];
    const p2 = [lat - Math.cos(Math.PI/2 - rH)*0.02, lon - Math.sin(Math.PI/2 - rH)*0.02];
    const p3 = [p2[0] + Math.cos(Math.PI/2 - rP)*0.015, p2[1] + Math.sin(Math.PI/2 - rP)*0.015];
    const p4 = [p1[0] + Math.cos(Math.PI/2 - rP)*0.015, p1[1] + Math.sin(Math.PI/2 - rP)*0.015];

    pattern.setLatLngs([p1, p2, p3, p4, p1]);
}

function transfer() {
    const sel = document.getElementById('tab2Rwy');
    sel.innerHTML = "";
    for(let r in db[cur.id].rwys) {
        let opt = new Option("RWY " + r, r);
        if(r === cur.best) opt.selected = true;
        sel.add(opt);
    }
    refreshTab2();
    switchTab(2);
}

function refreshTab2() {
    const rwy = document.getElementById('tab2Rwy').value;
    const hdg = db[cur.id].rwys[rwy];
    const s = side === 'L' ? -1 : 1;

    // 羅盤更新
    document.getElementById('rwyVisual').style.transform = `translate(-50%, -50%) rotate(${hdg - 90}deg)`;
    document.getElementById('num1').innerText = rwy;
    document.getElementById('num2').innerText = (parseInt(rwy) > 18 ? parseInt(rwy)-18 : parseInt(rwy)+18).toString().padStart(2,'0');
    document.getElementById('windArrow').style.transform = `translate(-50%, -100%) rotate(${cur.dir}deg)`;

    // WCA 計算
    const legs = [
        { n: "Upwind", t: hdg },
        { n: "Crosswind", t: (hdg + 270*s + 360) % 360 },
        { n: "Downwind", t: (hdg + 180) % 360 },
        { n: "Base", t: (hdg + 90*s + 360) % 360 }
    ];

    let html = "";
    legs.forEach(l => {
        const a = (cur.dir - l.t) * Math.PI / 180;
        const wca = Math.round(Math.asin((cur.spd * Math.sin(a)) / 90) * 180 / Math.PI);
        const fH = (l.t + wca + 360) % 360;
        html += `<tr style="border-bottom: 1px solid #334155"><td style="padding:10px 0">${l.n}</td><td align="center">${l.t}°</td><td align="center" style="color:var(--red)">${wca>0?'+':''}${wca}°</td><td align="right"><b>${fH}°</b></td></tr>`;
    });
    document.getElementById('wcaList').innerHTML = html;
    drawPattern(cur.id, rwy);
}

function setSide(s) {
    side = s;
    document.getElementById('bL').className = s === 'L' ? 'active' : '';
    document.getElementById('bR').className = s === 'R' ? 'active' : '';
    refreshTab2();
}

function switchTab(n) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab' + n).classList.add('active');
    document.querySelectorAll('.tab-btn')[n-1].classList.add('active');
    if(n===1) setTimeout(() => map.invalidateSize(), 200);
}

window.onload = init;
</script>
</body>
</html>
