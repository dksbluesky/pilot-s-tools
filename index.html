<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor V5 (Final Calibration)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-dark: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --text: #f8fafc; --text-dim: #94a3b8; --green: #4ade80; --red: #fb7185;
            --compass-blue: #1e3a8a;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 480px; margin: 0 auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card-bg); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .label-sm { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }

        /* UI Clone: Pocket METAR Style */
        .est-runway-row { display: flex; align-items: center; gap: 20px; margin-top: 8px; }
        .rwy-id { font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; color: white; }
        .v-line { width: 2px; height: 50px; background: #475569; }
        .wind-info { font-size: 1rem; line-height: 1.4; }
        .val-num { color: var(--green); font-weight: bold; }

        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.85rem; line-height: 1.5; background: #000; padding: 10px; border-radius: 6px; border-left: 4px solid var(--green); margin-top: 8px; }

        /* Professional SVG Compass */
        .compass-container { position: relative; width: 260px; height: 260px; margin: 20px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .compass-svg { width: 100%; height: 100%; }
        .rwy-visual { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 8px; box-sizing: border-box; border-radius: 3px; }
        .rwy-visual::after { content: ''; position: absolute; top: 50%; left: 5%; right: 5%; height: 1px; border-top: 1px dashed rgba(255,255,255,0.6); transform: translateY(-50%); }
        .rwy-num { color: white; font-size: 10px; font-weight: bold; z-index: 11; font-family: monospace; }
        .wind-arrow { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center 130px; z-index: 15; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        #map { height: 260px; border-radius: 12px; margin-top: 10px; background: #111; border: 1px solid #444; }
        select { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; appearance: none; }
        .side-toggle { display: flex; gap: 8px; margin-top: 10px; }
        .side-toggle button { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #334155; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .side-toggle button.active { background: #f59e0b; color: #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">機場資訊</button>
        <button class="tab-btn" onclick="switchTab(2)">起降計算</button>
    </div>

    <div id="tab1" class="tab-content active">
        <div class="card">
            <span class="label-sm">ICAO 機場選擇</span>
            <select id="apSelect" onchange="updateData()"></select>
        </div>

        <div class="card">
            <span class="label-sm">原始電碼 RAW DATA (Real Mock)</span>
            <div id="rawView" class="raw-text">正在取得最新數據...</div>
        </div>

        <div class="card">
            <span class="label-sm">預估使用跑道 EST. RUNWAY</span>
            <div class="est-runway-row">
                <div id="estRwy" class="rwy-id">--</div>
                <div class="v-line"></div>
                <div class="wind-info">
                    <div>頂風 Head: <span id="hWind" class="val-num">0</span> KT</div>
                    <div>側風 Cross: <span id="cWind" class="val-num">0</span> KT</div>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">精確五邊地圖 (PATTERN OVERLAY)</span>
            <div id="map"></div>
        </div>
        
        <button onclick="transfer()" style="width:100%; padding:18px; background:var(--accent); color:black; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size: 1rem;">傳送至五邊計算頁面 ➔</button>
    </div>

    <div id="tab2" class="tab-content">
        <div class="card">
            <span class="label-sm">跑道與航線邊切換</span>
            <select id="tab2Rwy" onchange="refreshTab2()" style="margin-bottom:10px"></select>
            <div class="side-toggle">
                <button id="bL" class="active" onclick="setSide('L')">LEFT Traffic</button>
                <button id="bR" onclick="setSide('R')">RIGHT Traffic</button>
            </div>
        </div>

        <div class="card" style="text-align:center">
            <span class="label-sm">專業刻度羅盤 (HEADING & WIND)</span>
            <div class="compass-container">
                <svg class="compass-svg" viewBox="0 0 200 200" id="compassSvg"></svg>
                <div id="rwyVisual" class="rwy-visual">
                    <span id="num1" class="rwy-num">10</span>
                    <span id="num2" class="rwy-num">28</span>
                </div>
                <div id="windArrowContainer" class="wind-arrow">
                    <svg width="30" height="40" viewBox="0 0 30 40" style="position:absolute; top:-145px; left:-15px;">
                        <path d="M15 40 L30 15 L15 22 L0 15 Z" fill="#fff" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label-sm">各航段偏流修正 (WCA @ 90KT)</span>
            <table style="width:100%; font-size: 0.95rem; border-collapse: collapse; margin-top:10px;">
                <thead style="color:var(--text-dim); border-bottom: 1px solid #334155;">
                    <tr><th align="left" style="padding:8px">航段</th><th align="center">Track</th><th align="center">WCA</th><th align="right">Heading</th></tr>
                </thead>
                <tbody id="wcaList"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// 完整機場資料庫
const airportDB = {
    "RCSS": { name: "松山", lat: 25.0697, lon: 121.5525, rwys: { "10": 100, "28": 280 } },
    "RCTP": { name: "桃園", lat: 25.0797, lon: 121.2342, rwys: { "05L": 52, "23R": 232 } },
    "RCKH": { name: "高雄", lat: 22.5771, lon: 120.3500, rwys: { "09": 90, "27": 270 } },
    "RCMQ": { name: "台中", lat: 24.2582, lon: 120.6203, rwys: { "18": 180, "36": 360 } },
    "RCNN": { name: "台南", lat: 22.9507, lon: 120.2058, rwys: { "18R": 180, "36L": 360 } },
    "RCBS": { name: "金門", lat: 24.4297, lon: 118.3586, rwys: { "06": 60, "24": 240 } },
    "VHHH": { name: "香港", lat: 22.3089, lon: 113.9145, rwys: { "07L": 71, "25R": 251 } },
    "RJTT": { name: "羽田", lat: 35.5494, lon: 139.7798, rwys: { "34L": 337, "16R": 157 } }
};

let map, marker, patternOverlay, currentData = null, currentSide = 'L';

// 初始化
function init() {
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternOverlay = L.polyline([], { color: '#38bdf8', weight: 3, dashArray: '10, 10' }).addTo(map);
    
    // 填充選單
    const sel = document.getElementById('apSelect');
    for(let id in airportDB) sel.add(new Option(`${id} - ${airportDB[id].name}`, id));
    
    createCompassTicks();
    updateData();
}

// 建立羅盤刻度與文字
function createCompassTicks() {
    const svg = document.getElementById('compassSvg');
    let content = '';
    const labels = { 0:'N', 30:'3', 60:'6', 90:'E', 120:'12', 150:'15', 180:'S', 210:'21', 240:'24', 270:'W', 300:'30', 330:'33' };

    for(let i=0; i<360; i+=5) {
        let isLong = i % 30 === 0;
        let x1 = 100 + Math.sin(i*Math.PI/180) * (isLong ? 82 : 88);
        let y1 = 100 - Math.cos(i*Math.PI/180) * (isLong ? 82 : 88);
        let x2 = 100 + Math.sin(i*Math.PI/180) * 95;
        let y2 = 100 - Math.cos(i*Math.PI/180) * 95;
        content += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="${isLong?2:1}" />`;
        
        if(isLong) {
            let tx = 100 + Math.sin(i*Math.PI/180) * 70;
            let ty = 100 - Math.cos(i*Math.PI/180) * 70;
            content += `<text x="${tx}" y="${ty}" fill="white" font-size="12" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${labels[i]}</text>`;
        }
    }
    svg.innerHTML = content;
}

function updateData() {
    const id = document.getElementById('apSelect').value;
    const ap = airportDB[id];
    // 模擬複雜 METAR：變向風 + 多層雲 + 英吋汞柱氣壓計
    const raw = `${id} 010530Z 10007KT 050V140 9999 FEW012 SCT025 BKN040 18/14 Q1018 NOSIG RMK A3006`;
    document.getElementById('rawView').innerText = raw;
    
    const wind = raw.match(/(\d{3})(\d{2,3})KT/);
    const dir = parseInt(wind[1]), spd = parseInt(wind[2]);
    
    let best = "", minDiff = 180;
    for(let r in ap.rwys) {
        let diff = Math.abs(dir - ap.rwys[r]); if(diff > 180) diff = 360 - diff;
        if(diff < minDiff) { minDiff = diff; best = r; }
    }
    
    const rad = (minDiff * Math.PI) / 180;
    currentData = { id, dir, spd, best, hw: Math.round(spd*Math.cos(rad)), cw: Math.round(spd*Math.sin(rad)) };
    
    document.getElementById('estRwy').innerText = best;
    document.getElementById('hWind').innerText = currentData.hw;
    document.getElementById('cWind').innerText = currentData.cw;
    
    map.setView([ap.lat, ap.lon], 14);
    marker.setLatLng([ap.lat, ap.lon]);
    drawPatternOnMap(id, best);
}

// 修正後的五邊形繪製：考量墨卡托投影縮放與正確跑道航向
function drawPatternOnMap(id, rwy) {
    const ap = airportDB[id];
    const hdg = ap.rwys[rwy];
    const lat = ap.lat, lon = ap.lon;
    const side = currentSide === 'L' ? -1 : 1;
    
    // 比例係數：1海里在不同緯度的座標長度
    const latDist = 0.016; // 約 1 NM
    const lonDist = latDist / Math.cos(lat * Math.PI / 180);
    
    const toRad = Math.PI / 180;
    const hdgRad = hdg * toRad;
    const sideRad = (hdg + 90 * side) * toRad;

    // 計算四個轉向點 (基於 NM 的偏向量)
    const getPoint = (lDist, sDist) => {
        const dLat = Math.cos(hdgRad) * lDist * latDist + Math.cos(sideRad) * sDist * latDist;
        const dLon = Math.sin(hdgRad) * lDist * lonDist + Math.sin(sideRad) * sDist * lonDist;
        return [lat + dLat, lon + dLon];
    };

    const p1 = getPoint(1.5, 0);   // Final point
    const p2 = getPoint(-1.5, 0);  // Upwind point
    const p3 = getPoint(-1.5, 1);  // Crosswind to Downwind turn
    const p4 = getPoint(1.5, 1);   // Downwind to Base turn

    patternOverlay.setLatLngs([p1, p2, p3, p4, p1]);
}

function transfer() {
    const sel = document.getElementById('tab2Rwy');
    sel.innerHTML = "";
    for(let r in airportDB[currentData.id].rwys) {
        let opt = new Option("RWY " + r, r);
        if(r === currentData.best) opt.selected = true;
        sel.add(opt);
    }
    refreshTab2();
    switchTab(2);
}

function refreshTab2() {
    const rwy = document.getElementById('tab2Rwy').value;
    const hdg = airportDB[currentData.id].rwys[rwy];
    const s = currentSide === 'L' ? -1 : 1;

    // 更新羅盤視覺
    document.getElementById('rwyVisual').style.transform = `translate(-50%, -50%) rotate(${hdg - 90}deg)`;
    document.getElementById('num1').innerText = rwy;
    // 計算對面跑道號
    const opp = (parseInt(rwy) > 18 ? parseInt(rwy)-18 : parseInt(rwy)+18).toString().padStart(2,'0');
    document.getElementById('num2').innerText = opp;
    document.getElementById('windArrowContainer').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;

    // WCA 計算
    const legs = [
        { n: "Upwind", t: hdg },
        { n: "Crosswind", t: (hdg + 270*s + 360) % 360 },
        { n: "Downwind", t: (hdg + 180) % 360 },
        { n: "Base", t: (hdg + 90*s + 360) % 360 }
    ];

    let html = "";
    legs.forEach(l => {
        const angle = (currentData.dir - l.t) * Math.PI / 180;
        const wca = Math.round(Math.asin((currentData.spd * Math.sin(angle)) / 90) * 180 / Math.PI);
        const fly = (l.t + wca + 360) % 360;
        html += `<tr style="border-bottom: 1px solid #334155"><td style="padding:12px 8px">${l.n}</td><td align="center">${l.t}°</td><td align="center" style="color:var(--red)">${wca>0?'+':''}${wca}°</td><td align="right"><b>${fly.toString().padStart(3,'0')}°</b></td></tr>`;
    });
    document.getElementById('wcaList').innerHTML = html;
    drawPatternOnMap(currentData.id, rwy);
}

function setSide(s) {
    currentSide = s;
    document.getElementById('bL').className = s === 'L' ? 'active' : '';
    document.getElementById('bR').className = s === 'R' ? 'active' : '';
    refreshTab2();
}

function switchTab(n) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab' + n).classList.add('active');
    document.querySelectorAll('.tab-btn')[n-1].classList.add('active');
    if(n===1) setTimeout(() => map.invalidateSize(), 300);
}

window.onload = init;
</script>
</body>
</html>
