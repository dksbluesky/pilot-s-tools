<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket METAR Pro - Instructor Final Build</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --green: #4ade80; }
        body { background-color: var(--bg); color: var(--text); font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.85rem; background: #000; padding: 12px; border-radius: 8px; border-left: 4px solid var(--green); margin-top: 8px; white-space: pre-wrap; word-break: break-all; }
        #map { height: 280px; border-radius: 12px; background: #111; border: 1px solid #444; margin: 10px 0; }
        .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
        .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-radius: 3px; }
        .rwy-num { display: inline-block; color: white; font-size: 11px; font-weight: bold; font-family: monospace; transition: transform 0.3s; }
        .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; transition: transform 0.8s ease; }
        select { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; appearance: none; cursor: pointer; }
        .side-btn { width: 100%; height: 50px; border-radius: 8px; font-weight: bold; text-align: center; background: #334155; color: #94a3b8; border: 1px solid transparent; transition: all 0.3s; }
        .side-btn.active { background: #f59e0b; color: #000; border: 1px solid #fff; }
    </style>
</head>
<body class="p-4 pb-10">

<div class="container max-w-md mx-auto space-y-4">
    <div class="flex gap-1">
        <button class="tab-btn active" onclick="switchTab(1)">æ©Ÿå ´è³‡è¨Š</button>
        <button class="tab-btn" onclick="switchTab(2)">èµ·é™è¨ˆç®—</button>
    </div>

    <div id="tab1" class="tab-content active space-y-4">
        <div class="glass-panel p-4 rounded-xl"><span class="text-[0.7rem] text-slate-400 font-bold uppercase tracking-widest">Airport Select</span><select id="apSelect" onchange="update()" class="mt-2"></select></div>
        <div class="glass-panel p-4 rounded-xl">
            <div class="flex justify-between items-start mb-2"><span id="stn-id" class="text-2xl font-black text-white tracking-widest">--</span><span id="flt-cat" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-600">--</span></div>
            <div id="rawView" class="raw-text">æ­£åœ¨åŒæ­¥æ•¸æ“š...</div>
            <div class="text-[10px] text-slate-500 mt-2 text-right">UTC æ›´æ–°: <span id="obs-time">--:--</span></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="glass-panel p-4 rounded-xl flex flex-col items-center"><span class="text-[10px] text-slate-400 self-start font-bold">é¢¨é€Ÿ WIND</span><div class="mt-1"><span id="w-dir" class="text-lg font-bold">---</span>Â° / <span id="w-spd" class="text-2xl font-bold text-blue-400">0</span> <span class="text-xs text-slate-500">KT</span></div></div>
            <div class="glass-panel p-4 rounded-xl flex flex-col items-center text-center"><span class="text-[10px] text-slate-400 self-start font-bold">æ°£å£“ QNH</span><div id="qnhVal" class="text-xl font-bold mt-1">--</div><div id="qnh-hg" class="text-[10px] text-slate-500">-- inHg</div></div>
        </div>
        <div class="glass-panel p-4 rounded-xl"><div class="flex items-center gap-4"><div id="estRwy" class="text-4xl font-black text-white">--</div><div class="w-[2px] h-10 bg-slate-600"></div><div class="text-xs"><div>é ‚é¢¨ Head: <span id="hWind" class="text-green-400 font-bold">0</span> KT</div><div>å´é¢¨ Cross: <span id="cWind" class="text-blue-400 font-bold">0</span> KT</div></div></div></div>
        <div id="map"></div>
        <div class="glass-panel p-4 rounded-xl"><span class="text-[0.7rem] text-slate-400 font-bold flex items-center gap-1 uppercase"><i data-lucide="cloud" class="w-3 h-3"></i> Clouds</span><div id="cloudBox" class="mt-2 space-y-1"></div></div>
        <div class="glass-panel p-4 rounded-xl"><span class="text-[0.7rem] text-slate-400 font-bold flex items-center gap-1 uppercase"><i data-lucide="book-open" class="w-3 h-3"></i> Decoder</span><div id="visBox" class="mt-2 mb-2 p-2 bg-slate-900/50 rounded flex justify-between text-sm"><span>èƒ½è¦‹åº¦ Visibility</span><span id="visVal" class="font-bold">--</span></div><div id="decoderBox" class="mt-2 space-y-1 text-sm"></div></div>
        <button onclick="transfer()" class="w-full p-4 bg-orange-500 text-black font-black rounded-xl shadow-lg transition-all active:scale-95">å‚³é€è¨ˆç®— â”</button>
    </div>

    <div id="tab2" class="tab-content space-y-4">
        <div class="glass-panel p-4 rounded-xl">
            <select id="tab2Rwy" onchange="refreshTab2()"></select>
            <div class="grid grid-cols-2 gap-2 mt-3 w-full">
                <button id="bL" class="side-btn active" onclick="setSide('L')">LEFT Traffic</button>
                <button id="bR" class="side-btn" onclick="setSide('R')">RIGHT Traffic</button>
            </div>
        </div>
        <div class="glass-panel p-6 rounded-xl text-center"><div class="compass-wrap"><svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg><div id="rwyBar" class="rwy-bar"><span id="n1" class="rwy-num">--</span><span id="n2" class="rwy-num">--</span></div><div id="windPtr" class="wind-ptr"><svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;"><path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" /></svg></div></div></div>
        <div class="glass-panel p-4 rounded-xl"><table class="w-full text-sm"><tbody id="wcaList"></tbody></table></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// æ•¸æ“šå­—å…¸
const DICT = { "NOSIG": "æœªä¾†å…©å°æ™‚ç„¡é¡¯è‘—è®ŠåŒ–", "CAVOK": "èƒ½è¦‹åº¦>10km ä¸”ç„¡é›²", "WS": "æœ‰é¢¨åˆ‡ Wind Shear", "RMK": "å‚™è¨» Remarks" };
const CODES = { "RA": "ä¸‹é›¨", "DZ": "æ¯›æ¯›é›¨", "TS": "é›·é›¨", "FG": "éœ§", "HZ": "éœ¾", "BR": "è–„éœ§", "SH": "é™£é›¨" };

// æ©Ÿå ´è³‡æ–™åº«è£œå®Œ
const airportDB = {
    "RCTP": { name: "æ¡ƒåœ’ Taoyuan", lat: 25.0797, lon: 121.2342, rwys: { "05L/R": 50, "23L/R": 230 }, trueH: 48.8 },
    "RCSS": { name: "æ¾å±± Songshan", lat: 25.0697, lon: 121.5525, rwys: { "10": 100, "28": 280 }, trueH: 93.5 },
    "RCKH": { name: "é«˜é›„ Kaohsiung", lat: 22.5771, lon: 120.3500, rwys: { "09": 90, "27": 270 }, trueH: 84.2 },
    "RCMQ": { name: "å°ä¸­ Taichung", lat: 24.2582, lon: 120.6203, rwys: { "36": 360, "18": 180 }, trueH: 355 },
    "RCNN": { name: "å°å— Tainan", lat: 22.9507, lon: 120.2058, rwys: { "18L/R": 180, "36L/R": 360 }, trueH: 176.5 },
    "RCBS": { name: "é‡‘é–€ Kinmen", lat: 24.4297, lon: 118.3586, rwys: { "06": 60, "24": 240 }, trueH: 56 },
    "RCQC": { name: "æ¾æ¹– Penghu", lat: 23.5681, lon: 119.6281, rwys: { "02": 20, "20": 200 }, trueH: 16.5 },
    "VHHH": { name: "é¦™æ¸¯ Hong Kong", lat: 22.3089, lon: 113.9145, rwys: { "07L/R": 70, "25L/R": 250 }, trueH: 71 },
    "VMMC": { name: "æ¾³é–€ Macau", lat: 22.1495, lon: 113.5915, rwys: { "16": 160, "34": 340 }, trueH: 158 },
    "ZSPD": { name: "ä¸Šæµ· Pudong", lat: 31.1433, lon: 121.8052, rwys: { "16/17": 165, "34/35": 345 }, trueH: 152 },
    "ZBAA": { name: "åŒ—äº¬é¦–éƒ½ Beijing", lat: 40.0799, lon: 116.6031, rwys: { "36/01": 360, "18/19": 180 }, trueH: 183 },
    "RJBB": { name: "å¤§é˜ª Kansai", lat: 34.4347, lon: 135.2441, rwys: { "06L/R": 60, "24L/R": 240 }, trueH: 55 },
    "RJTT": { name: "æ±äº¬ç¾½ç”° Haneda", lat: 35.5494, lon: 139.7798, rwys: { "34L/R": 340, "16L/R": 160 }, trueH: 330 },
    "RJAA": { name: "æ±äº¬æˆç”° Narita", lat: 35.7647, lon: 140.3863, rwys: { "16L/R": 160, "34L/R": 340 }, trueH: 149 },
    "RKSI": { name: "é¦–çˆ¾ Incheon", lat: 37.4602, lon: 126.4407, rwys: { "15/16": 155, "33/34": 335 }, trueH: 146 },
    "WSSS": { name: "æ–°åŠ å¡ Singapore", lat: 1.3644, lon: 103.9915, rwys: { "02L/C/R": 20, "20L/C/R": 200 }, trueH: 20 },
    "VTBS": { name: "æ›¼è°· Suvarnabhumi", lat: 13.6931, lon: 100.7501, rwys: { "01L/R": 10, "19L/R": 190 }, trueH: 11 },
    "RPLL": { name: "é¦¬å°¼æ‹‰ Manila", lat: 14.5082, lon: 121.0197, rwys: { "06/24": 60, "13/31": 130 }, trueH: 60 },
    "KJFK": { name: "ç´ç´„ JFK", lat: 40.6413, lon: -73.7781, rwys: { "04L/R": 40, "22L/R": 220, "13L/R": 130, "31L/R": 310 }, trueH: 57 },
    "KLAX": { name: "æ´›æ‰ç£¯ LAX", lat: 33.9416, lon: -118.4085, rwys: { "06/07": 70, "24/25": 250 }, trueH: 58 },
    "EGLL": { name: "å€«æ•¦ Heathrow", lat: 51.4700, lon: -0.4543, rwys: { "09L/R": 90, "27L/R": 270 }, trueH: 89 },
    "LFPG": { name: "å·´é» CDG", lat: 49.0097, lon: 2.5479, rwys: { "08/09": 85, "26/27": 265 }, trueH: 84 }
};

const groups = [{ label: "ğŸ‡¹ğŸ‡¼ å°ç£ Taiwan", ids: ["RCTP", "RCSS", "RCKH", "RCMQ", "RCNN", "RCBS", "RCQC"] }, { label: "ğŸŒ æ¸¯æ¾³/ä¸­åœ‹", ids: ["VHHH", "VMMC", "ZSPD", "ZBAA"] }, { label: "ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· æ—¥éŸ“", ids: ["RJBB", "RJTT", "RJAA", "RKSI"] }, { label: "ğŸŒ´ æ±å—äº", ids: ["WSSS", "VTBS", "RPLL"] }, { label: "ğŸ‡ºğŸ‡¸ğŸ‡ªğŸ‡º æ­ç¾", ids: ["KJFK", "KLAX", "EGLL", "LFPG"] }];

let map, marker, patternLine, currentData = null, trafficSide = 'L';

async function update() {
    const id = document.getElementById('apSelect').value, ap = airportDB[id];
    if(!ap) return;
    document.getElementById('rawView').innerText = `æ­£åœ¨æ›´æ–° ${id}...`;
    
    let raw = "";
    try {
        // ç¬¬ä¸€é‡ä¿éšªï¼šVATSIM ç›´é€£
        const resp = await fetch(`https://metar.vatsim.net/metar.php?id=${id}&t=${Date.now()}`);
        raw = (await resp.text()).trim();
        if(!raw || raw.length < 5) throw new Error();
    } catch(e) {
        // ç¬¬äºŒé‡ä¿éšªï¼šå‚™æ´èˆ‡æ¨¡æ“¬ (é˜²æ­¢é»‘å±å¡æ­»)
        raw = `${id} 010630Z 10009KT 9999 FEW012 BKN035 17/14 Q1018 NOSIG`;
        document.getElementById('rawView').style.color = "#666"; 
    }

    document.getElementById('rawView').innerText = raw;
    document.getElementById('stn-id').innerText = id;
    const wM = raw.match(/(\d{3}|VRB)(\d{2,3})KT/);
    const dir = wM ? (wM[1]==='VRB'?0:parseInt(wM[1])) : 0, spd = wM ? parseInt(wM[2]) : 0;
    document.getElementById('w-dir').innerText = wM ? wM[1] : "---";
    document.getElementById('w-spd').innerText = spd;

    // è§£æé‚è¼¯ç§»æ¤
    let cHtml = "", dHtml = "", ceiling = 10000;
    const cloudRegex = /(FEW|SCT|BKN|OVC|VV)(\d{3})/g; let cm;
    while((cm = cloudRegex.exec(raw))) {
        const alt = parseInt(cm[2])*100;
        cHtml += `<div class="bg-slate-800/50 p-2 rounded-lg border-l-4 border-blue-400 flex justify-between"><b>${cm[1]}</b><span>${alt} ft</span></div>`;
        if((cm[1]==='BKN'||cm[1]==='OVC') && alt < ceiling) ceiling = alt;
    }
    document.getElementById('cloudBox').innerHTML = cHtml || "Sky Clear / NSC";

    const qM = raw.match(/Q(\d{4})/);
    document.getElementById('qnhVal').innerText = qM ? qM[1]+" hPa" : "1013";
    if(qM) document.getElementById('qnh-hg').innerText = (parseInt(qM[1])*0.02953).toFixed(2) + " inHg";

    // è§£ç¢¼å™¨å¼·åŒ–
    const tokens = raw.split(" ");
    tokens.forEach(t => {
        let cl = t.replace(/^RE/, ""), intensity = "";
        if(cl.startsWith("+")) intensity = "å¼· (Heavy) "; else if(cl.startsWith("-")) intensity = "å¼± (Light) ";
        for(let cd in CODES) if(cl.includes(cd)) dHtml += `<div class="p-1 border-b border-slate-700/50 flex gap-2"><b>${t}</b><span class="text-blue-300">${intensity}${CODES[cd]}</span></div>`;
    });
    for(let k in DICT) if(raw.includes(k)) dHtml += `<div class="p-1 border-b border-slate-700/50 flex gap-2"><b>${k}</b><span class="text-slate-400">${DICT[k]}</span></div>`;
    document.getElementById('decoderBox').innerHTML = dHtml || "ç„¡ç‰¹æ®Šä»£ç¢¼";

    const badge = document.getElementById('flt-cat');
    badge.innerText = (raw.includes("CAVOK") || ceiling >= 3000) ? "VFR" : "MVFR";
    badge.className = `px-3 py-1 rounded-full text-xs font-bold ${badge.innerText==="VFR"?'bg-green-500 text-black':'bg-blue-500 text-white'}`;

    let best = "", maxH = -99;
    for(let r in ap.rwys) {
        let diff = Math.abs(dir - ap.rwys[r]); if(diff > 180) diff = 360 - diff;
        let hw = Math.round(spd * Math.cos(diff * Math.PI / 180));
        if(hw > maxH) { maxH = hw; best = r; }
    }
    currentData = { id, dir, spd, best, hw: maxH, cw: Math.round(spd * Math.sin(Math.abs(dir-ap.rwys[best]) * Math.PI / 180)) };
    document.getElementById('estRwy').innerText = best;
    document.getElementById('hWind').innerText = currentData.hw;
    document.getElementById('cWind').innerText = currentData.cw;
    map.setView([ap.lat, ap.lon], 14); marker.setLatLng([ap.lat, ap.lon]);
    drawPattern(id, best);
}

function drawPattern(id, rwy) {
    const ap = airportDB[id], s = trafficSide==='L'?-1:1;
    const baseH = ap.trueH + (rwy.includes('28')||rwy.includes('23')||rwy.includes('18')?180:0);
    const latF = 1/60, lonF = latF/Math.cos(ap.lat*Math.PI/180), toR = Math.PI/180;
    const rH = (90-baseH)*toR, rS = (90-(baseH+90*s))*toR;
    const m = (p, a, d) => [p[0]+Math.sin(a)*d*latF, p[1]+Math.cos(a)*d*lonF];
    const c = [ap.lat, ap.lon];
    patternLine.setLatLngs([m(c,rH,1.5), m(c,rH,-1.5), m(m(c,rH,-1.5),rS,1.2), m(m(c,rH,1.5),rS,1.2), m(c,rH,1.5)]);
}

function init() {
    const sel = document.getElementById('apSelect');
    groups.forEach(g => {
        let gr = document.createElement('optgroup'); gr.label = g.label;
        g.ids.forEach(id => { if(airportDB[id]) gr.appendChild(new Option(`${id} - ${airportDB[id].name}`, id)); });
        sel.appendChild(grp);
    });
    sel.value = "RCSS";
    map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.0697, 121.5525]).addTo(map);
    patternLine = L.polyline([], { color: '#38bdf8', weight: 3, dashArray: '10, 10' }).addTo(map);
    const svg = document.getElementById('compSvg'), lbls = { 0:'N', 90:'E', 180:'S', 270:'W' };
    let h = ''; for(let i=0; i<360; i+=10) {
        let isL = i%30===0, x1=100+Math.sin(i*Math.PI/180)*(isL?82:88), y1=100-Math.cos(i*Math.PI/180)*(isL?82:88), x2=100+Math.sin(i*Math.PI/180)*96, y2=100-Math.cos(i*Math.PI/180)*96;
        h += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="${isL?2:1}" />`;
        if(i%90===0) h += `<text x="${100+Math.sin(i*Math.PI/180)*72}" y="${100-Math.cos(i*Math.PI/180)*72}" fill="white" font-size="14" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${lbls[i]}</text>`;
    }
    svg.innerHTML = h; lucide.createIcons(); update();
}

function transfer() {
    const s = document.getElementById('tab2Rwy'); s.innerHTML = "";
    if(!currentData) return;
    for(let r in airportDB[currentData.id].rwys) { let o = new Option("RWY " + r, r); if(r === currentData.best) o.selected = true; s.add(o); }
    refreshTab2(); switchTab(2);
}

function refreshTab2() {
    const r = document.getElementById('tab2Rwy').value, ap = airportDB[currentData.id], magH = ap.rwys[r], rot = magH - 90;
    document.getElementById('rwyBar').style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
    const n1 = document.getElementById('n1'), n2 = document.getElementById('n2');
    n1.innerText = r.split('/')[0]; n2.innerText = (parseInt(n1.innerText)>18?parseInt(n1.innerText)-18:parseInt(n1.innerText)+18).toString().padStart(2,'0');
    n1.style.transform = `rotate(${-rot}deg)`; n2.style.transform = `rotate(${-rot}deg)`;
    document.getElementById('windPtr').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;
    const legs = [{n:"Upwind",t:magH},{n:"Cross",t:(magH+270*(trafficSide==='L'?-1:1)+360)%360},{n:"Downwind",t:(magH+180)%360},{n:"Base",t:(magH+90*(trafficSide==='L'?-1:1)+360)%360}];
    let h = ""; legs.forEach(l => {
        const a = (currentData.dir - l.t) * Math.PI / 180, wca = Math.round(Math.asin((currentData.spd * Math.sin(a)) / 90) * 180 / Math.PI);
        h += `<tr class="border-b border-slate-700/50"><td class="py-3 px-1">${l.n}</td><td align="center">${Math.round(l.t)}Â°</td><td align="center" class="text-rose-400">${wca>0?'+':''}${wca}Â°</td><td align="right" class="font-bold text-lg">${((l.t+wca+360)%360).toString().padStart(3,'0')}Â°</td></tr>`;
    });
    document.getElementById('wcaList').innerHTML = h; drawPattern(currentData.id, r);
}

function setSide(s) { trafficSide = s; document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active')); (s==='L'?document.getElementById('bL'):document.getElementById('bR')).classList.add('active'); if(currentData) refreshTab2(); }
function switchTab(n) { document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab'+n).classList.add('active'); document.querySelectorAll('.tab-btn')[n-1].classList.add('active'); if(n===1 && map) setTimeout(() => map.invalidateSize(), 300); }
window.onload = init;
</script>
</body>
</html>
